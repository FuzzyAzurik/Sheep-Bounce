/**
 * PhysicsJS v0.5.3 - 2013-11-25
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2013 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

/**
 * @license
 * Lo-Dash 2.2.1 (Custom Build) lodash.com/license | Underscore.js 1.5.2 underscorejs.org/LICENSE
 * Build: `lodash exports="none" iife="(function(window){%output%;lodash.extend(Physics.util, lodash);}(this));" include="isObject,isFunction,isArray,isPlainObject,uniqueId,each,random,extend,clone,throttle,bind,sortedIndex,shuffle" --minify --output lib/lodash.js`
 */

(function(e,t){typeof exports=="object"?module.exports=t.call(e):typeof define=="function"&&define.amd?define([],function(){return t.call(e)}):e.Physics=t.call(e)})(this,function(){var e=function n(){return n.world.apply(n,arguments)};e.util={},!function(t){function n(e){return typeof e.toString!="function"&&typeof (e+"")=="string"}function r(){}function i(e){e.length=0,T.length<L&&T.push(e)}function s(e,t,n){t||(t=0),typeof n=="undefined"&&(n=e?e.length:0);var r=-1;n=n-t||0;for(var i=Array(0>n?0:n);++r<n;)i[r]=e[t+r];return i}function o(){}function u(e,t,r,o,a){if(r){var f=r(e);if(typeof f!="undefined")return f}if(!m(e))return e;var l=ot.call(e);if(!U[l]||!wt.nodeClass&&n(e))return e;var c=yt[l];switch(l){case H:case B:return new c(+e);case F:case R:return new c(e);case q:return f=c(e.source,A.exec(e)),f.lastIndex=e.lastIndex,f}if(l=St(e),t){var h=!o;o||(o=T.pop()||[]),a||(a=T.pop()||[]);for(var p=o.length;p--;)if(o[p]==e)return a[p];f=l?c(e.length):{}}else f=l?s(e):kt({},e);return l&&(nt.call(e,"index")&&(f.index=e.index),nt.call(e,"input")&&(f.input=e.input)),t?(o.push(e),a.push(f),(l?Ct:At)(e,function(e,n){f[n]=u(e,t,r,o,a)}),h&&(i(o),i(a)),f):f}function a(e,t,n){if(typeof e!="function")return E;if(typeof t=="undefined")return e;var r=e.__bindData__||wt.funcNames&&!e.name;if(typeof r=="undefined"){var i=M&&et.call(e);wt.funcNames||!i||O.test(i)||(r=!0),(wt.funcNames||!r)&&(r=!wt.funcDecomp||M.test(i),Et(e,r))}if(!0!==r&&r&&1&r[1])return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)};case 4:return function(n,r,i,s){return e.call(t,n,r,i,s)}}return b(e,t)}function f(e,t,r,s,o,u){if(r){var a=r(e,t);if(typeof a!="undefined")return!!a}if(e===t)return 0!==e||1/e==1/t;if(e===e&&!(e&&V[typeof e]||t&&V[typeof t]))return!1;if(null==e||null==t)return e===t;var l=ot.call(e),c=ot.call(t);if(l==D&&(l=I),c==D&&(c=I),l!=c)return!1;switch(l){case H:case B:return+e==+t;case F:return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case q:case R:return e==t+""}if(c=l==P,!c){if(nt.call(e,"__wrapped__")||nt.call(t,"__wrapped__"))return f(e.__wrapped__||e,t.__wrapped__||t,r,s,o,u);if(l!=I||!wt.nodeClass&&(n(e)||n(t)))return!1;var l=!wt.argsObject&&d(e)?Object:e.constructor,h=!wt.argsObject&&d(t)?Object:t.constructor;if(l!=h&&!(v(l)&&l instanceof l&&v(h)&&h instanceof h))return!1}for(h=!o,o||(o=T.pop()||[]),u||(u=T.pop()||[]),l=o.length;l--;)if(o[l]==e)return u[l]==t;var p=0,a=!0;if(o.push(e),u.push(t),c){if(l=e.length,p=t.length,a=p==e.length,!a&&!s)return a;for(;p--;)if(c=l,h=t[p],s)for(;c--&&!(a=f(e[c],h,r,s,o,u)););else if(!(a=f(e[p],h,r,s,o,u)))break;return a}return Lt(t,function(t,n,i){return nt.call(i,n)?(p++,a=nt.call(e,n)&&f(e[n],t,r,s,o,u)):void 0}),a&&!s&&Lt(e,function(e,t,n){return nt.call(n,t)?a=-1<--p:void 0}),h&&(i(o),i(u)),a}function l(e,t,n,r,i,s){var o=1&t,u=2&t,a=4&t,f=8&t,c=16&t,p=32&t,d=e;if(!u&&!v(e))throw new TypeError;c&&!n.length&&(t&=-17,c=n=!1),p&&!r.length&&(t&=-33,p=r=!1);var g=e&&e.__bindData__;if(g)return!o||1&g[1]||(g[4]=i),!o&&1&g[1]&&(t|=8),!a||4&g[1]||(g[5]=s),c&&it.apply(g[2]||(g[2]=[]),n),p&&it.apply(g[3]||(g[3]=[]),r),g[1]|=t,l.apply(null,g);if(!o||u||a||p||!(wt.fastBind||ft&&c))b=function(){var v=arguments,g=o?i:this;return(a||c||p)&&(v=mt.call(v),c&&ut.apply(v,n),p&&it.apply(v,r),a&&v.length<s)?(t|=16,l(e,f?t:-4&t,v,null,i,s)):(u&&(e=g[d]),this instanceof b?(g=h(e.prototype),v=e.apply(g,v),m(v)?v:g):e.apply(g,v))};else{if(c){var y=[i];it.apply(y,n)}var b=c?ft.apply(e,y):ft.call(e,i)}return Et(b,mt.call(arguments)),b}function c(){X.h=_,X.b=X.c=X.g=X.i="",X.e="t",X.j=!0;for(var e,t=0;e=arguments[t];t++)for(var n in e)X[n]=e[n];t=X.a,X.d=/^[^,]+/.exec(t)[0],e=Function,t="return function("+t+"){",n=X;var r="var n,t="+n.d+",E="+n.e+";if(!t)return E;"+n.i+";";n.b?(r+="var u=t.length;n=-1;if("+n.b+"){",wt.unindexedChars&&(r+="if(s(t)){t=t.split('')}"),r+="while(++n<u){"+n.g+";}}else{"):wt.nonEnumArgs&&(r+="var u=t.length;n=-1;if(u&&p(t)){while(++n<u){n+='';"+n.g+";}}else{"),wt.enumPrototypes&&(r+="var G=typeof t=='function';"),wt.enumErrorProps&&(r+="var F=t===k||t instanceof Error;");var i=[];if(wt.enumPrototypes&&i.push('!(G&&n=="prototype")'),wt.enumErrorProps&&i.push('!(F&&(n=="message"||n=="name"))'),n.j&&n.f)r+="var C=-1,D=B[typeof t]&&v(t),u=D?D.length:0;while(++C<u){n=D[C];",i.length&&(r+="if("+i.join("&&")+"){"),r+=n.g+";",i.length&&(r+="}"),r+="}";else if(r+="for(n in t){",n.j&&i.push("m.call(t, n)"),i.length&&(r+="if("+i.join("&&")+"){"),r+=n.g+";",i.length&&(r+="}"),r+="}",wt.nonEnumShadows){for(r+="if(t!==A){var i=t.constructor,r=t===(i&&i.prototype),f=t===J?I:t===k?j:L.call(t),x=y[f];",k=0;7>k;k++)r+="n='"+n.h[k]+"';if((!(r&&x[n])&&m.call(t,n))",n.j||(r+="||(!x[n]&&t[n]!==A[n])"),r+="){"+n.g+"}";r+="}"}return(n.b||wt.nonEnumArgs)&&(r+="}"),r+=n.c+";return E",e("d,j,k,m,o,p,q,s,v,A,B,y,I,J,L",t+r+"}")(a,j,K,nt,C,d,St,g,X.f,Q,V,bt,R,G,ot)}function h(e){return m(e)?lt(e):{}}function p(e){var t,r;return!e||ot.call(e)!=I||(t=e.constructor,v(t)&&!(t instanceof t))||!wt.argsClass&&d(e)||!wt.nodeClass&&n(e)?!1:wt.ownLast?(Lt(e,function(e,t,n){return r=nt.call(n,t),!1}),!1!==r):(Lt(e,function(e,t){r=t}),typeof r=="undefined"||nt.call(e,r))}function d(e){return e&&typeof e=="object"&&typeof e.length=="number"&&ot.call(e)==D||!1}function v(e){return typeof e=="function"}function m(e){return!!e&&!!V[typeof e]}function g(e){return typeof e=="string"||ot.call(e)==R}function y(e,t,n){if(t&&typeof n=="undefined"&&St(e)){n=-1;for(var r=e.length;++n<r&&!1!==t(e[n],n,e););}else Ct(e,t,n);return e}function b(e,t){return 2<arguments.length?l(e,17,mt.call(arguments,2),null,t):l(e,1,null,null,t)}function w(e,t,n){var r,i,s,o,u,a,f,l=0,c=!1,h=!0;if(!v(e))throw new TypeError;if(t=pt(0,t)||0,!0===n)var p=!0,h=!1;else m(n)&&(p=n.leading,c="maxWait"in n&&(pt(t,n.maxWait)||0),h="trailing"in n?n.trailing:h);var d=function(){var n=t-(rt()-o);0<n?a=setTimeout(d,n):(i&&clearTimeout(i),n=f,i=a=f=x,n&&(l=rt(),s=e.apply(u,r)))},g=function(){a&&clearTimeout(a),i=a=f=x,(h||c!==t)&&(l=rt(),s=e.apply(u,r))};return function(){if(r=arguments,o=rt(),u=this,f=h&&(a||!p),!1===c)var n=p&&!a;else{i||p||(l=o);var v=c-(o-l);0<v?i||(i=setTimeout(g,v)):(i&&(i=clearTimeout(i)),l=o,s=e.apply(u,r))}return a||t===c||(a=setTimeout(d,t)),n&&(s=e.apply(u,r)),s}}function E(e){return e}function S(e,t,n){var r=null==e,i=null==t;return null==n&&(typeof e=="boolean"&&i?(n=e,e=1):i||typeof t!="boolean"||(n=t,i=!0)),r&&i&&(t=1),e=+e||0,i?(t=e,e=0):t=+t||0,r=vt(),n||e%1||t%1?dt(e+r*(t-e+parseFloat("1e-"+((r+"").length-1))),t):e+Z(r*(t-e+1))}var x,T=[],N=0,C={},L=40,A=/\w*$/,O=/^function[ \n\r\t]+\w/,M=/\bthis\b/,_="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),D="[object Arguments]",P="[object Array]",H="[object Boolean]",B="[object Date]",j="[object Error]",F="[object Number]",I="[object Object]",q="[object RegExp]",R="[object String]",U={"[object Function]":!1};U[D]=U[P]=U[H]=U[B]=U[F]=U[I]=U[q]=U[R]=!0;var z={leading:!1,maxWait:0,trailing:!1},W={configurable:!1,enumerable:!1,value:null,writable:!1},X={a:"",b:null,c:"",d:"",e:"",v:null,g:"",h:null,support:null,i:"",j:!1},V={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,"undefined":!1},$=V[typeof t]&&t||this,J=[],K=Error.prototype,Q=Object.prototype,G=String.prototype,Y=RegExp("^"+(Q.valueOf+"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),Z=Math.floor,et=Function.prototype.toString,tt=Y.test(tt=Object.getPrototypeOf)&&tt,nt=Q.hasOwnProperty,rt=Y.test(rt=Date.now)&&rt||function(){return+(new Date)},it=J.push,st=Q.propertyIsEnumerable,ot=Q.toString,ut=J.unshift,at=function(){try{var e={},t=Y.test(t=Object.defineProperty)&&t,n=t(e,e,e)&&t}catch(r){}return n}(),ft=Y.test(ft=ot.bind)&&ft,lt=Y.test(lt=Object.create)&&lt,ct=Y.test(ct=Array.isArray)&&ct,ht=Y.test(ht=Object.keys)&&ht,pt=Math.max,dt=Math.min,vt=Math.random,mt=J.slice;t=Y.test($.attachEvent);var gt=ft&&!/\n|true/.test(ft+t),yt={};yt[P]=Array,yt[H]=Boolean,yt[B]=Date,yt["[object Function]"]=Function,yt[I]=Object,yt[F]=Number,yt[q]=RegExp,yt[R]=String;var bt={};bt[P]=bt[B]=bt[F]={constructor:!0,toLocaleString:!0,toString:!0,valueOf:!0},bt[H]=bt[R]={constructor:!0,toString:!0,valueOf:!0},bt[j]=bt["[object Function]"]=bt[q]={constructor:!0,toString:!0},bt[I]={constructor:!0},function(){for(var e=_.length;e--;){var t,n=_[e];for(t in bt)nt.call(bt,t)&&!nt.call(bt[t],n)&&(bt[t][n]=!1)}}();var wt=o.support={};!function(){var e=function(){this.x=1},t={0:1,length:1},n=[];e.prototype={valueOf:1,y:1};for(var r in new e)n.push(r);for(r in arguments);wt.argsClass=ot.call(arguments)==D,wt.argsObject=arguments.constructor==Object&&!(arguments instanceof Array),wt.enumErrorProps=st.call(K,"message")||st.call(K,"name"),wt.enumPrototypes=st.call(e,"prototype"),wt.fastBind=ft&&!gt,wt.funcDecomp=!Y.test($.WinRTError)&&M.test(function(){return this}),wt.funcNames=typeof Function.name=="string",wt.nonEnumArgs=0!=r,wt.nonEnumShadows=!/valueOf/.test(n),wt.ownLast="x"!=n[0],wt.spliceObjects=(J.splice.call(t,0,1),!t[0]),wt.unindexedChars="xx"!="x"[0]+Object("x")[0];try{wt.nodeClass=ot.call(document)!=I||!!({toString:0}+"")}catch(i){wt.nodeClass=!0}}(1),lt||(h=function(e){if(m(e)){r.prototype=e;var t=new r;r.prototype=null}return t||{}});var Et=at?function(e,t){W.value=t,at(e,"__bindData__",W)}:r;wt.argsClass||(d=function(e){return e&&typeof e=="object"&&typeof e.length=="number"&&nt.call(e,"callee")||!1});var St=ct||function(e){return e&&typeof e=="object"&&typeof e.length=="number"&&ot.call(e)==P||!1},xt=c({a:"z",e:"[]",i:"if(!(B[typeof z]))return E",g:"E.push(n)"}),Tt=ht?function(e){return m(e)?wt.enumPrototypes&&typeof e=="function"||wt.nonEnumArgs&&e.length&&d(e)?xt(e):ht(e):[]}:xt,ct={a:"g,e,K",i:"e=e&&typeof K=='undefined'?e:d(e,K,3)",b:"typeof u=='number'",v:Tt,g:"if(e(t[n],n,g)===false)return E"};t={a:"z,H,l",i:"var a=arguments,b=0,c=typeof l=='number'?2:a.length;while(++b<c){t=a[b];if(t&&B[typeof t]){",v:Tt,g:"if(typeof E[n]=='undefined')E[n]=t[n]",c:"}}"};var Nt={i:"if(!B[typeof t])return E;"+ct.i,b:!1},Ct=c(ct),kt=c(t,{i:t.i.replace(";",";if(c>3&&typeof a[c-2]=='function'){var e=d(a[--c-1],a[c--],2)}else if(c>2&&typeof a[c-1]=='function'){e=a[--c]}"),g:"E[n]=e?e(E[n],t[n]):t[n]"}),Lt=c(ct,Nt,{j:!1}),At=c(ct,Nt);v(/x/)&&(v=function(e){return typeof e=="function"&&"[object Function]"==ot.call(e)}),ct=tt?function(e){if(!e||ot.call(e)!=I||!wt.argsClass&&d(e))return!1;var t=e.valueOf,n=typeof t=="function"&&(n=tt(t))&&tt(n);return n?e==n||tt(e)==n:p(e)}:p,o.assign=kt,o.bind=b,o.createCallback=function(e,t,n){var r=typeof e;if(null==e||"function"==r)return a(e,t,n);if("object"!=r)return function(t){return t[e]};var i=Tt(e),s=i[0],o=e[s];return 1!=i.length||o!==o||m(o)?function(t){for(var n=i.length,r=!1;n--&&(r=f(t[i[n]],e[i[n]],null,!0)););return r}:function(e){return e=e[s],o===e&&(0!==o||1/o==1/e)}},o.debounce=w,o.forEach=y,o.forIn=Lt,o.forOwn=At,o.keys=Tt,o.shuffle=function(e){var t=-1,n=e?e.length:0,r=Array(typeof n=="number"?n:0);return y(e,function(e){var n=S(++t);r[t]=r[n],r[n]=e}),r},o.throttle=function(e,t,n){var r=!0,i=!0;if(!v(e))throw new TypeError;return!1===n?r=!1:m(n)&&(r="leading"in n?n.leading:r,i="trailing"in n?n.trailing:i),z.leading=r,z.maxWait=t,z.trailing=i,w(e,t,z)},o.each=y,o.extend=kt,o.clone=function(e,t,n,r){return typeof t!="boolean"&&null!=t&&(r=n,n=t,t=!1),u(e,t,typeof n=="function"&&a(n,r,1))},o.identity=E,o.isArguments=d,o.isArray=St,o.isFunction=v,o.isObject=m,o.isPlainObject=ct,o.isString=g,o.random=S,o.sortedIndex=function(e,t,n,r){var i=0,s=e?e.length:i;for(n=n?o.createCallback(n,r,1):E,t=n(t);i<s;)r=i+s>>>1,n(e[r])<t?i=r+1:s=r;return i},o.uniqueId=function(e){var t=++N;return(null==e?"":e)+""+t},o.VERSION="2.2.1",o.extend(e.util,o)}(this);var t=e.util.decorator=function(n,r){var i={},s={},o=function(n,r){return e.util.isFunction(r)?r:n},u=Object.getPrototypeOf;typeof u!="function"&&(typeof "test".__proto__=="object"?u=function(e){return e.__proto__}:u=function(e){return e.constructor.prototype});var a=Object.create;typeof a!="function"&&(a=function(e){function t(){}return t.prototype=e,new t});var f=function(r,i){if(typeof r=="object"){s=e.util.extend(s,r,o),s.type=n;return}r!=="type"&&e.util.isFunction(i)&&(s[r]=i)};f(r);var l=function(r,f,l,c){var h,p,d=s,v;if(typeof f!="string")c=l,l=f;else{d=i[f];if(!d)throw'Error: "'+f+'" '+n+" not defined";d=d.prototype}if(typeof l=="function")p=i[r],p?p.prototype=e.util.extend(p.prototype,l(u(p.prototype)),o):(p=i[r]=function m(e){this.init&&this.init(e)},p.prototype=a(d),p.prototype=e.util.extend(p.prototype,l(d),o)),p.prototype.type=n,p.prototype.name=r;else{c=l||{},p=i[r];if(!p)throw'Error: "'+r+'" '+n+" not defined"}if(c)return new p(c)};return l.mixin=f,l};return function(t){var n=t.Physics;e.noConflict=function(){return t.Physics===e&&(t.Physics=n),e}}(this),function(){var t=function n(e){if(!(this instanceof n))return new n(e);this.initPubsub(e)};t.prototype={initPubsub:function(e){this._topics={},this._defaultScope=e||this},subscribe:function(t,n,r,i){var s=this._topics[t]||(this._topics[t]=[]),o=n,u;if(e.util.isObject(t)){for(var a in t)this.subscribe(a,t[a],n,r);return this}return e.util.isObject(r)?(n=e.util.bind(n,r),n._bindfn_=o):i||(i=r),n._priority_=i,u=e.util.sortedIndex(s,n,"_priority_"),s.splice(u,0,n),this},unsubscribe:function(e,t){if(e===!0)return this._topics={},this;var n=this._topics[e],r;if(!n)return this;if(t===!0)return this._topics[e]=[],this;for(var i=0,s=n.length;i<s;i++){r=n[i];if(r._bindfn_===t||r===t){n.splice(i,1);break}}return this},publish:function(e,t){typeof e!="object"&&(e={topic:e});var n=e.topic,r=this._topics[n],i=r&&r.length;if(!n)throw"Error: No topic specified in call to world.publish()";if(!i)return this;e.scope=e.scope||this._defaultScope;while(i--)e.handler=r[i],e.handler(e);return this}},e.util.pubsub=t}(),function(e){var t=0,n=["ms","moz","webkit","o"];for(var r=0;r<n.length&&!e.requestAnimationFrame;++r)e.requestAnimationFrame=e[n[r]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[n[r]+"CancelAnimationFrame"]||e[n[r]+"CancelRequestAnimationFrame"];e.requestAnimationFrame||(e.requestAnimationFrame=function(n,r){var i=(new Date).getTime(),s=Math.max(0,16-(i-t)),o=e.setTimeout(function(){n(i+s)},s);return t=i+s,o}),e.cancelAnimationFrame||(e.cancelAnimationFrame=function(e){clearTimeout(e)})}(this),function(){var t=100,n=10,r="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",i="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",s="Error: Too many scratchpads created. (Did you forget to call .done()?)",o=[],u=0,a=function(){this.objIndex=0,this.arrayIndex=0,this.vectorIndex=0,this.aabbIndex=0,this.transformIndex=0,this.objectStack=[],this.arrayStack=[],this.vectorStack=[],this.aabbStack=[],this.transformStack=[];if(++u>=t)throw s};a.prototype={done:function(){this._active=!1,this.objIndex=this.arrayIndex=this.vectorIndex=this.aabbIndex=this.transformIndex=0,o.push(this)},object:function(){var e=this.objectStack;if(!this._active)throw r;if(this.objIndex>=n)throw i;return e[this.objIndex++]||e[e.push({})-1]},array:function(){var e=this.arrayStack;if(!this._active)throw r;if(this.arrIndex>=n)throw i;return e[this.arrIndex++]||e[e.push([])-1]},vector:function(){var t=this.vectorStack;if(!this._active)throw r;if(this.vectorIndex>=n)throw i;return t[this.vectorIndex++]||t[t.push(e.vector())-1]},aabb:function(){var t=this.aabbStack;if(!this._active)throw r;if(this.aabbIndex>=n)throw i;return t[this.aabbIndex++]||t[t.push(e.aabb())-1]},transform:function(){var t=this.transformStack;if(!this._active)throw r;if(this.transformIndex>=n)throw i;return t[this.transformIndex++]||t[t.push(e.transform())-1]}},e.scratchpad=function(){var e=o.pop()||new a;return e._active=!0,e}}(),function(t){function s(e){var o=i;if(!r)return;t.requestAnimationFrame(s);for(var u=0,a=o.length;u<a;++u)o[u](e,e-n);n=e}function o(){return n=(new Date).getTime(),r=!0,s(),this}function u(){return r=!1,this}function a(e){if(typeof e=="function"){for(var t=0,n=i.length;t<n;++t)if(e===i[t])return this;i.push(e)}return this}function f(e){var t=i;for(var n=0,r=t.length;n<r;++n)if(t[n]===e)return t.splice(n,1),this;return this}function l(){return!!r}var n=0,r=!1,i=[];e.util.ticker={start:o,stop:u,subscribe:a,unsubscribe:f,isActive:l}}(this),function(){var t=function n(t,r,i,s){if(!(this instanceof n))return new n(t,r,i,s);this._pos=e.vector(),this.set(t,r,i,s)};t.prototype.set=function(n,r,i,s){return e.util.isObject(n)?(this._pos.clone(n.pos),this._hw=n.halfWidth,this._hh=n.halfHeight,this):(this._pos.set(.5*(i+n),.5*(s+r)),this._hw=.5*(i-n),this._hh=.5*(s-r),this)},t.prototype.get=function(){var t=this.halfWidth(),n=this.halfHeight();return{pos:this._pos.values(),halfWidth:t,halfHeight:n,x:t,y:n}},t.prototype.halfWidth=function(){return this._hw},t.prototype.halfHeight=function(){return this._hh},t.prototype.contains=function(t){var n=t.x!==undefined?t.x:t.get(0),r=t.y!==undefined?t.y:t.get(1);return n>this._pos.get(0)-this._hw&&n<this._pos.get(0)+this._hw&&r>this._pos.get(1)-this._hh&&r<this._pos.get(1)+this._hh},t.prototype.transform=function(n){var r=this._hw,i=this._hh,s=e.scratchpad(),o=s.vector().set(r,i),u=s.vector().set(r,-i);return this._pos.translate(n),o.rotate(n),u.rotate(n),this._hw=Math.max(Math.abs(o.get(0)),Math.abs(u.get(0))),this._hh=Math.max(Math.abs(o.get(1)),Math.abs(u.get(1))),s.done(),this},t.contains=function(e,t){var n=t.x!==undefined?t.x:t.get(0),r=t.y!==undefined?t.y:t.get(1);return e=e.get?e.get():e,n>e.pos.x-e.halfWidth&&n<e.pos.x+e.halfWidth&&r>e.pos.y-e.halfHeight&&r<e.pos.y+e.halfHeight},e.aabb=t}(),function(){var t=1e-4,n=100,r=function(t,n,r){var i=n.normSq()-n.dot(t),s=n.dot(t)-t.normSq();return i<0?r.clone(n).negate():s>0?r.clone(t).negate():(r.clone(n).vsub(t),r.perp(t.cross(r)<0))},i=function(n){var r=n.length,i=n[r-2],s=n[r-3],o=e.scratchpad(),u=o.vector().clone(i.pt),a=o.vector().clone(s.pt).vsub(u),f,l;if(a.equals(e.vector.zero))return o.done(),{a:i.a,b:i.b};f=-a.dot(u)/a.normSq(),l=1-f;if(l<=0)return o.done(),{a:s.a,b:s.b};if(f<=0)return o.done(),{a:i.a,b:i.b};var c={a:u.clone(i.a).mult(l).vadd(a.clone(s.a).mult(f)).values(),b:u.clone(i.b).mult(l).vadd(a.clone(s.b).mult(f)).values()};return o.done(),c},s=function(o,u,a,f){var l=!1,c=!1,h=!1,p=[],d=1,v=e.scratchpad(),m=v.vector().clone(u||e.vector.axis[0]),g=v.vector(),y=v.vector(),b=v.vector(),w=v.vector(),E,S,x,T,N=0;T=o(m),d=p.push(T),g.clone(T.pt),m.negate();while(++N){g.swap(y),T=o(m),d=p.push(T),g.clone(T.pt),f&&f(p);if(g.equals(e.vector.zero)){l=!0;break}if(!c&&g.dot(m)<=0){if(a)break;c=!0}if(d===2)m=r(g,y,m);else if(c){m.normalize(),T=y.dot(m);if(Math.abs(T-g.dot(m))<t){h=-T;break}y.normSq()<b.clone(p[0].pt).normSq()?p.shift():p.splice(1,1),m=r(b.clone(p[1].pt),w.clone(p[0].pt),m)}else{E=E||v.vector(),S=S||v.vector(),E.clone(y).vsub(g),S.clone(p[0].pt).vsub(g),x=E.cross(S)>0;if(x^g.cross(E)>0)p.shift(),E.perp(x),m.swap(E);else{if(!(x^S.cross(g)>0)){l=!0;break}p.splice(1,1),S.perp(!x),m.swap(E)}}if(N>n)return v.done(),{simplex:p,iterations:N,distance:0,maxIterationsReached:!0}}return v.done(),T={overlap:l,simplex:p,iterations:N},h!==!1&&(T.distance=h,T.closest=i(p)),T};e.gjk=s}(),function(){var t=function n(t,r,i){if(!(this instanceof n))return new n(t,r);this.v=e.vector(),this.o=e.vector();if(t instanceof n){this.clone(t);return}t&&this.setTranslation(t),this.setRotation(r||0,i)};t.prototype.setTranslation=function(e){return this.v.clone(e),this},t.prototype.setRotation=function(e,t){return this.cosA=Math.cos(e),this.sinA=Math.sin(e),t?this.o.clone(t):this.o.zero(),this},t.prototype.clone=function(e){return e?(this.setTranslation(e.v),this.cosA=e.cosA,this.sinA=e.sinA,this.o.clone(e.o),this):new t(this)},e.transform=t}(),function(t){var n=Math.sqrt,r=Math.min,i=Math.max,s=Math.acos,o=Math.atan2,u=Math.PI*2,a=!!t.Float64Array,f=function l(e,t){if(!(this instanceof l))return new l(e,t);a?this._=new Float64Array(5):this._=[],e&&(e.x!==undefined||e._&&e._.length)?this.clone(e):(this.recalc=!0,this.set(e||0,t||0))};f.prototype.set=function(e,t){return this.recalc=!0,this._[0]=e||0,this._[1]=t||0,this},f.prototype.get=function(e){return this._[e]},f.prototype.vadd=function(e){return this.recalc=!0,this._[0]+=e._[0],this._[1]+=e._[1],this},f.prototype.vsub=function(e){return this.recalc=!0,this._[0]-=e._[0],this._[1]-=e._[1],this},f.prototype.add=function(e,t){return this.recalc=!0,this._[0]+=e,this._[1]+=t===undefined?e:t,this},f.prototype.sub=function(e,t){return this.recalc=!0,this._[0]-=e,this._[1]-=t===undefined?e:t,this},f.prototype.mult=function(e){return this.recalc||(this._[4]*=e*e,this._[3]*=e),this._[0]*=e,this._[1]*=e,this},f.prototype.dot=function(e){return this._[0]*e._[0]+this._[1]*e._[1]},f.prototype.cross=function(e){return-this._[0]*e._[1]+this._[1]*e._[0]},f.prototype.proj=function(e){return this.dot(e)/e.norm()},f.prototype.vproj=function(e){var t=this.dot(e)/e.normSq();return this.clone(e).mult(t)},f.prototype.angle=function(e){var t;if(this.equals(f.zero))return e?e.angle():NaN;e&&!e.equals(f.zero)?t=o(this._[1]*e._[0]-this._[0]*e._[1],this._[0]*e._[0]+this._[1]*e._[1]):t=o(this._[1],this._[0]);while(t>Math.PI)t-=u;while(t<-Math.PI)t+=u;return t},f.prototype.angle2=function(e,t){var n=e._[0]-this._[0],r=e._[1]-this._[1],i=t._[0]-this._[0],s=t._[1]-this._[1],a=o(r*i-n*s,n*i+r*s);while(a>Math.PI)a-=u;while(a<-Math.PI)a+=u;return a},f.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=n(this._[4])),this._[3]},f.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=n(this._[4])),this._[4]},f.prototype.dist=function(e){var t,r;return n((t=e._[0]-this._[0])*t+(r=e._[1]-this._[1])*r)},f.prototype.distSq=function(e){var t,n;return(t=e._[0]-this._[0])*t+(n=e._[1]-this._[1])*n},f.prototype.perp=function(e){var t=this._[0];return e?(this._[0]=-this._[1],this._[1]=t):(this._[0]=this._[1],this._[1]=-t),this},f.prototype.normalize=function(){var e=this.norm();return e===0?this:(e=1/e,this._[0]*=e,this._[1]*=e,this._[3]=1,this._[4]=1,this)},f.prototype.transform=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r,this._[1]-=i,this.set(this._[0]*n-this._[1]*t+r+e.v._[0],this._[0]*t+this._[1]*n+i+e.v._[1])},f.prototype.transformInv=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r+e.v._[0],this._[1]-=i+e.v._[1],this.set(this._[0]*n+this._[1]*t+r,-this._[0]*t+this._[1]*n+i)},f.prototype.rotate=function(e,t){var n,r,i=0,s=0;return typeof e=="number"?(n=Math.sin(e),r=Math.cos(e),t&&(i=(t.x||t._[0])|0,s=(t.y||t._[1])|0)):(n=e.sinA,r=e.cosA,i=e.o._[0],s=e.o._[1]),this._[0]-=i,this._[1]-=s,this.set(this._[0]*r-this._[1]*n+i,this._[0]*n+this._[1]*r+s)},f.prototype.rotateInv=function(e){return this.set((this._[0]-e.o._[0])*e.cosA+(this._[1]-e.o._[1])*e.sinA+e.o._[0],-(this._[0]-e.o._[0])*e.sinA+(this._[1]-e.o._[1])*e.cosA+e.o._[1])},f.prototype.translate=function(e){return this.vadd(e.v)},f.prototype.translateInv=function(e){return this.vsub(e.v)},f.prototype.clone=function(e){return e?e._?(this.recalc=e.recalc,e.recalc||(this._[3]=e._[3],this._[4]=e._[4]),this._[0]=e._[0],this._[1]=e._[1],this):this.set(e.x,e.y):new f(this)},f.prototype.swap=function(e){var t=this._;return this._=e._,e._=t,t=this.recalc,this.recalc=e.recalc,e.recalc=t,this},f.prototype.values=function(){return{x:this._[0],y:this._[1]}},f.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},f.prototype.negate=function(e){return e!==undefined?(this._[e]=-this._[e],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},f.prototype.clamp=function(e,t){return e=e.values?e.values():e,t=t.values?t.values():t,this._[0]=r(i(this._[0],e.x),t.x),this._[1]=r(i(this._[1],e.y),t.y),this.recalc=!0,this},f.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},f.prototype.equals=function(e){return this._[0]===e._[0]&&this._[1]===e._[1]&&this._[2]===e._[2]},f.vadd=function(e,t){return new f(e._[0]+t._[0],e._[1]+t._[1])},f.vsub=function(e,t){return new f(e._[0]-t._[0],e._[1]-t._[1])},f.mult=function(e,t){return new f(t._[0]*e,t._[1]*e)},f.vproj=function(e,t){return f.mult(e.dot(t)/t.normSq(),t)},f.axis=[new f(1,0),new f(0,1)],f.zero=new f(0,0),e.vector=f}(this),function(){e.behavior=e.behaviour=t("behavior",{priority:0,init:function(){this.options={}},connect:function(e){this.behave&&e.subscribe("integrate:positions",this.behave,this,this.priority)},disconnect:function(e){this.behave&&e.unsubscribe("integrate:positions",this.behave)},behave:null})}(),function(){var n={fixed:!1,mass:1,restitution:1,cof:.8,view:null};e.body=t("body",{init:function(t){var r=e.vector;this.options=e.util.extend({},n,t),this.fixed=this.options.fixed,this.hidden=this.options.hidden,this.mass=this.options.mass,this.restitution=this.options.restitution,this.cof=this.options.cof,this.view=this.options.view,this.state={pos:r(t.x,t.y),vel:r(t.vx,t.vy),acc:r(),angular:{pos:t.angle||0,vel:t.angularVelocity||0,acc:0},old:{pos:r(),vel:r(),acc:r(),angular:{pos:0,vel:0,acc:0}}};if(this.mass===0)throw"Error: Bodies must have non-zero mass";this.geometry=e.geometry("point")},accelerate:function(e){return this.state.acc.vadd(e),this},applyForce:function(t,n){var r=e.scratchpad(),i=r.vector(),s;return n?this.moi&&(s=this.state,i.clone(n),this.state.angular.acc-=i.cross(t)/this.moi,this.applyForce(t)):this.accelerate(i.clone(t).mult(1/this.mass)),r.done(),this},aabb:function(){var t=e.scratchpad(),n=t.transform(),r=this.state.angular.pos,i=t.aabb().set(this.geometry.aabb(r));return n.setRotation(0).setTranslation(this.state.pos),i.transform(n),i=i.get(),t.done(),i},recalc:function(){}})}(),function(){e.geometry=t("geometry",{init:function(t){this._aabb=new e.aabb},aabb:function(e){return this._aabb.get()},getFarthestHullPoint:function(t,n){return n=n||e.vector(),n.set(0,0)},getFarthestCorePoint:function(t,n,r){return n=n||e.vector(),n.set(0,0)}})}(),e.geometry.isPolygonConvex=function(t){var n=e.scratchpad(),r=n.vector(),i=n.vector(),s=n.vector(),o=!0,u=!1,a=t.length;if(!t||!a)return!1;if(a<3)return n.done(),o;r.clone(t[0]).vsub(s.clone(t[a-1]));for(var f=1;f<=a;++f){i.clone(t[f%a]).vsub(s.clone(t[(f-1)%a]));if(u===!1)u=r.cross(i);else if(u>0^r.cross(i)>0){o=!1;break}i.swap(r)}return n.done(),o},e.geometry.getPolygonMOI=function(t){var n=e.scratchpad(),r=n.vector(),i=n.vector(),s=0,o=0,u,a=t.length;if(a<2)return n.done(),0;if(a===2)return u=i.clone(t[1]).distSq(r.clone(t[0])),n.done(),u/12;r.clone(t[0]);for(var f=1;f<a;++f)i.clone(t[f]),u=Math.abs(i.cross(r)),s+=u*(i.normSq()+i.dot(r)+r.normSq()),o+=u,r.swap(i);return n.done(),s/(6*o)},e.geometry.isPointInPolygon=function(t,n){var r=e.scratchpad(),i=r.vector().clone(t),s=r.vector(),o=r.vector(),u=0,a=n.length;if(a<2)return u=i.equals(s.clone(n[0])),r.done(),u;if(a===2)return u=i.angle(s.clone(n[0])),u+=i.angle(s.clone(n[1])),r.done(),Math.abs(u)===Math.PI;s.clone(n[0]).vsub(i);for(var f=1;f<=a;++f)o.clone(n[f%a]).vsub(i),u+=o.angle(s),s.swap(o);return r.done(),Math.abs(u)>0},e.geometry.getPolygonArea=function(n){var r=e.scratchpad(),i=r.vector(),s=r.vector(),o=0,u=n.length;if(u<3)return r.done(),0;i.clone(n[u-1]);for(var a=0;a<u;++a)s.clone(n[a]),o+=i.cross(s),i.swap(s);return r.done(),o/2},e.geometry.getPolygonCentroid=function(n){var r=e.scratchpad(),i=r.vector(),s=r.vector(),o=e.vector(),u,a=n.length;if(a<2)return r.done(),e.vector(n[0]);if(a===2)return r.done(),e.vector((n[1].x+n[0].x)/2,(n[1].y+n[0].y)/2);i.clone(n[a-1]);for(var f=0;f<a;++f)s.clone(n[f]),u=i.cross(s),i.vadd(s).mult(u),o.vadd(i),i.swap(s);return u=1/(6*e.geometry.getPolygonArea(n)),r.done(),o.mult(u)},e.geometry.nearestPointOnLine=function(n,r,i){var s=e.scratchpad(),o=s.vector().clone(n),u=s.vector().clone(r).vsub(o),a=s.vector().clone(i).vsub(o).vsub(u),f,l;return a.equals(e.vector.zero)?(s.done(),e.vector(r)):(f=-a.dot(u)/a.normSq(),l=1-f,l<=0?(s.done(),e.vector(i)):f<=0?(s.done(),e.vector(r)):(o=e.vector(i).mult(f).vadd(u.clone(r).mult(l)),s.done(),o))},function(){var n={drag:0};e.integrator=t("integrator",{init:function(t){this.options=e.util.extend({},n,t)},integrate:function(e,t){var n=this._world;return this.integrateVelocities(e,t),n&&n.publish({topic:"integrate:velocities",bodies:e,dt:t}),this.integratePositions(e,t),n&&n.publish({topic:"integrate:positions",bodies:e,dt:t}),this},integrateVelocities:function(e,t){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(e,t){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var n={meta:!1,metaRefresh:200,width:600,height:600};e.renderer=t("renderer",{init:function(t){var r=typeof t.el=="string"?document.getElementById(t.el):t.el;this.options=e.util.extend({},n,t),this.el=r?r:document.body,this.drawMeta=e.util.throttle(e.util.bind(this.drawMeta,this),this.options.metaRefresh)},render:function(e,t){var n,r,i;this.beforeRender&&this.beforeRender(),this._world.publish({topic:"beforeRender",renderer:this,bodies:e,stats:t}),this.options.meta&&this.drawMeta(t);for(var s=0,o=e.length;s<o;++s)n=e[s],r=n.view||(n.view=this.createView(n.geometry)),n.hidden||this.drawBody(n,r);return this},createView:function(e){throw"You must overried the renderer.createView() method."},drawMeta:function(e){throw"You must overried the renderer.drawMeta() method."},drawBody:function(e,t){throw"You must overried the renderer.drawBody() method."}})}(),function(){var t=function(e){this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e)};e.util.each("body,behavior,integrator,renderer".split(","),function(n,r){e[n].mixin("setWorld",t)});var n=function s(e,t,n){var r,i,o=function(){return s(e,t,n)};while(r=e.shift()){i=r.apply(t,n);if(i&&i.then)return i.then(o)}},r={timestep:6.25,maxIPF:16,webworker:!1,integrator:"verlet"},i=function o(e,t){if(!(this instanceof o))return new o(e,t);this.init(e,t)};i.prototype=e.util.extend({},e.util.pubsub.prototype,{init:function(t,r){if(e.util.isFunction(t)||e.util.isArray(t))r=t,t={};this._stats={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._opts={},this.initPubsub(this),this.options(t||{}),e.util.isFunction(r)?n([r],this,[this,e]):e.util.isArray(r)&&n(r,this,[this,e])},options:function(t){return t?(e.util.extend(this._opts,r,t),this.timeStep(this._opts.timestep),this.add(e.integrator(this._opts.integrator)),this):e.util.clone(this._opts)},add:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e,i;if(!r)return this;do{switch(r.type){case"behavior":this.addBehavior(r);break;case"integrator":this.integrator(r);break;case"renderer":this.renderer(r);break;case"body":this.addBody(r);break;default:throw'Error: failed to add item of unknown type "'+r.type+'" to world'}i={topic:"add:"+r.type},i[r.type]=r,this.publish(i)}while(++t<n&&(r=e[t]));return this},remove:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e,i;if(!r)return this;do{switch(r.type){case"behavior":this.removeBehavior(r);break;case"integrator":r===this._integrator&&this.integrator(null);break;case"renderer":r===this._renderer&&this.renderer(null);break;case"body":this.removeBody(r);break;default:throw'Error: failed to remove item of unknown type "'+r.type+'" from world'}i={topic:"add:"+r.type},i[r.type]=r,this.publish(i)}while(++t<n&&(r=e[t]));return this},integrator:function(e){return e===undefined?this._integrator:(this._integrator&&this._integrator.setWorld(null),e&&(this._integrator=e,this._integrator.setWorld(this)),this)},renderer:function(e){return e===undefined?this._renderer:(this._renderer&&this._renderer.setWorld(null),e&&(this._renderer=e,this._renderer.setWorld(this)),this)},timeStep:function(e){return e?(this._dt=e,this._maxJump=e*this._opts.maxIPF,this):this._dt},addBehavior:function(e){return e.setWorld(this),this._behaviors.push(e),this},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(e){var t=this._behaviors,n;if(e){for(var r=0,i=t.length;r<i;++r)if(e===t[r]){t.splice(r,1);break}n={topic:"remove:behavior"},n.behavior=e,this.publish(n)}return this},addBody:function(e){return e.setWorld(this),this._bodies.push(e),this},getBodies:function(){return[].concat(this._bodies)},removeBody:function(e){var t=this._bodies,n;if(e){for(var r=0,i=t.length;r<i;++r)if(e===t[r]){t.splice(r,1);break}n={topic:"remove:body"},n.body=e,this.publish(n)}return this},findOne:function(t){var n={check:function(e){var t=this;while(t=t.next)if(t(e))return!0;return!1}},r=n,i=this._bodies;t.$within,t.$at&&(r.next=function(n){var r=n.aabb();return e.aabb.contains(r,t.$at)});for(var s=0,o=i.length;s<o;++s)if(n.check(i[s]))return i[s];return!1},iterate:function(e){this._integrator.integrate(this._bodies,e)},step:function(e){if(this._paused)return this._time=!1,this;var t=this._time||(this._time=e),n=e-t,r=this._stats,i=this._dt;if(!n)return this;n>this._maxJump&&(this._time=e-this._maxJump,n=this._maxJump),r.fps=1e3/n,r.ipf=Math.ceil(n/this._dt);while(this._time<e)this._time+=i,this.iterate(i);return this.publish({topic:"step"}),this},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._stats),this.publish({topic:"render",bodies:this._bodies,stats:this._stats,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.publish({topic:"pause"}),this},unpause:function(){return this._paused=!1,this.publish({topic:"unpause"}),this},isPaused:function(){return!!this._paused},destroy:function(){var e=this;e.pause(),e.unsubscribe(!0),e.remove(e.getBodies()),e.remove(e.getBehaviors()),e.integrator(null),e.renderer(null)}}),e.world=i}(),e.integrator("verlet",function(t){return e.body.mixin({started:function(e){return e!==undefined&&(this._started=!0),!!this._started}}),{init:function(e){t.init.call(this,e)},integrateVelocities:function(e,t){var n=t*t,r=1-this.options.drag,i=null,s;for(var o=0,u=e.length;o<u;++o)i=e[o],s=i.state,i.fixed?(s.vel.zero(),s.acc.zero(),s.angular.vel=0,s.angular.acc=0):(s.vel.equals(s.old.vel)&&i.started()?s.vel.clone(s.pos).vsub(s.old.pos):(s.old.pos.clone(s.pos).vsub(s.vel),s.vel.mult(t)),r&&s.vel.mult(r),s.vel.vadd(s.acc.mult(n)),s.vel.mult(1/t),s.old.vel.clone(s.vel),s.acc.zero(),s.angular.vel===s.old.angular.vel&&i.started()?s.angular.vel=s.angular.pos-s.old.angular.pos:(s.old.angular.pos=s.angular.pos-s.angular.vel,s.angular.vel*=t),s.angular.vel+=s.angular.acc*n,s.angular.vel/=t,s.old.angular.vel=s.angular.vel,s.angular.acc=0,i.started(!0))},integratePositions:function(e,t){var n=t*t,r=null,i;for(var s=0,o=e.length;s<o;++s)r=e[s],i=r.state,r.fixed||(i.vel.mult(t),i.old.pos.clone(i.pos),i.pos.vadd(i.vel),i.vel.mult(1/t),i.old.vel.clone(i.vel),i.angular.vel*=t,i.old.angular.pos=i.angular.pos,i.angular.pos+=i.angular.vel,i.angular.vel/=t,i.old.angular.vel=i.angular.vel)}}}),e.geometry("point",function(e){}),e});