/**
 * PhysicsJS v0.5.3 - 2013-11-25
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2013 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

!function(e,t){"object"==typeof exports?module.exports=t.call(e):"function"==typeof define&&define.amd?define([],function(){return t.call(e)}):e.Physics=t.call(e)}(this,function(){var e=function n(){return n.world.apply(n,arguments)};e.util={},!function(t){function n(e){return"function"!=typeof e.toString&&"string"==typeof (e+"")}function r(){}function i(e){e.length=0,N.length<A&&N.push(e)}function s(e,t,n){t||(t=0),"undefined"==typeof n&&(n=e?e.length:0);var r=-1;n=n-t||0;for(var i=Array(0>n?0:n);++r<n;)i[r]=e[t+r];return i}function o(){}function u(e,t,r,o,a){if(r){var f=r(e);if("undefined"!=typeof f)return f}if(!g(e))return e;var l=ut.call(e);if(!z[l]||!Et.nodeClass&&n(e))return e;var c=bt[l];switch(l){case B:case j:return new c(+e);case I:case U:return new c(e);case R:return f=c(e.source,O.exec(e)),f.lastIndex=e.lastIndex,f}if(l=xt(e),t){var h=!o;o||(o=N.pop()||[]),a||(a=N.pop()||[]);for(var p=o.length;p--;)if(o[p]==e)return a[p];f=l?c(e.length):{}}else f=l?s(e):Lt({},e);return l&&(rt.call(e,"index")&&(f.index=e.index),rt.call(e,"input")&&(f.input=e.input)),t?(o.push(e),a.push(f),(l?kt:Ot)(e,function(e,n){f[n]=u(e,t,r,o,a)}),h&&(i(o),i(a)),f):f}function f(e,t,n){if("function"!=typeof e)return S;if("undefined"==typeof t)return e;var r=e.__bindData__||Et.funcNames&&!e.name;if("undefined"==typeof r){var i=_&&tt.call(e);Et.funcNames||!i||M.test(i)||(r=!0),(Et.funcNames||!r)&&(r=!Et.funcDecomp||_.test(i),St(e,r))}if(!0!==r&&r&&1&r[1])return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)};case 4:return function(n,r,i,s){return e.call(t,n,r,i,s)}}return w(e,t)}function l(e,t,r,s,o,u){if(r){var a=r(e,t);if("undefined"!=typeof a)return!!a}if(e===t)return 0!==e||1/e==1/t;if(e===e&&!(e&&$[typeof e]||t&&$[typeof t]))return!1;if(null==e||null==t)return e===t;var f=ut.call(e),c=ut.call(t);if(f==P&&(f=q),c==P&&(c=q),f!=c)return!1;switch(f){case B:case j:return+e==+t;case I:return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case R:case U:return e==t+""}if(c=f==H,!c){if(rt.call(e,"__wrapped__")||rt.call(t,"__wrapped__"))return l(e.__wrapped__||e,t.__wrapped__||t,r,s,o,u);if(f!=q||!Et.nodeClass&&(n(e)||n(t)))return!1;var f=!Et.argsObject&&v(e)?Object:e.constructor,h=!Et.argsObject&&v(t)?Object:t.constructor;if(f!=h&&!(m(f)&&f instanceof f&&m(h)&&h instanceof h))return!1}for(h=!o,o||(o=N.pop()||[]),u||(u=N.pop()||[]),f=o.length;f--;)if(o[f]==e)return u[f]==t;var p=0,a=!0;if(o.push(e),u.push(t),c){if(f=e.length,p=t.length,a=p==e.length,!a&&!s)return a;for(;p--;)if(c=f,h=t[p],s)for(;c--&&!(a=l(e[c],h,r,s,o,u)););else if(!(a=l(e[p],h,r,s,o,u)))break;return a}return At(t,function(t,n,i){return rt.call(i,n)?(p++,a=rt.call(e,n)&&l(e[n],t,r,s,o,u)):void 0}),a&&!s&&At(e,function(e,t,n){return rt.call(n,t)?a=-1<--p:void 0}),h&&(i(o),i(u)),a}function c(e,t,n,r,i,s){var o=1&t,u=2&t,a=4&t,f=8&t,l=16&t,h=32&t,d=e;if(!u&&!m(e))throw new TypeError;l&&!n.length&&(t&=-17,l=n=!1),h&&!r.length&&(t&=-33,h=r=!1);var v=e&&e.__bindData__;if(v)return!o||1&v[1]||(v[4]=i),!o&&1&v[1]&&(t|=8),!a||4&v[1]||(v[5]=s),l&&st.apply(v[2]||(v[2]=[]),n),h&&st.apply(v[3]||(v[3]=[]),r),v[1]|=t,c.apply(null,v);if(!o||u||a||h||!(Et.fastBind||lt&&l))b=function(){var v=arguments,m=o?i:this;return(a||l||h)&&(v=gt.call(v),l&&at.apply(v,n),h&&st.apply(v,r),a&&v.length<s)?(t|=16,c(e,f?t:-4&t,v,null,i,s)):(u&&(e=m[d]),this instanceof b?(m=p(e.prototype),v=e.apply(m,v),g(v)?v:m):e.apply(m,v))};else{if(l){var y=[i];st.apply(y,n)}var b=l?lt.apply(e,y):lt.call(e,i)}return St(b,gt.call(arguments)),b}function h(){V.h=D,V.b=V.c=V.g=V.i="",V.e="t",V.j=!0;for(var e,t=0;e=arguments[t];t++)for(var n in e)V[n]=e[n];t=V.a,V.d=/^[^,]+/.exec(t)[0],e=Function,t="return function("+t+"){",n=V;var r="var n,t="+n.d+",E="+n.e+";if(!t)return E;"+n.i+";";n.b?(r+="var u=t.length;n=-1;if("+n.b+"){",Et.unindexedChars&&(r+="if(s(t)){t=t.split('')}"),r+="while(++n<u){"+n.g+";}}else{"):Et.nonEnumArgs&&(r+="var u=t.length;n=-1;if(u&&p(t)){while(++n<u){n+='';"+n.g+";}}else{"),Et.enumPrototypes&&(r+="var G=typeof t=='function';"),Et.enumErrorProps&&(r+="var F=t===k||t instanceof Error;");var i=[];if(Et.enumPrototypes&&i.push('!(G&&n=="prototype")'),Et.enumErrorProps&&i.push('!(F&&(n=="message"||n=="name"))'),n.j&&n.f)r+="var C=-1,D=B[typeof t]&&v(t),u=D?D.length:0;while(++C<u){n=D[C];",i.length&&(r+="if("+i.join("&&")+"){"),r+=n.g+";",i.length&&(r+="}"),r+="}";else if(r+="for(n in t){",n.j&&i.push("m.call(t, n)"),i.length&&(r+="if("+i.join("&&")+"){"),r+=n.g+";",i.length&&(r+="}"),r+="}",Et.nonEnumShadows){for(r+="if(t!==A){var i=t.constructor,r=t===(i&&i.prototype),f=t===J?I:t===k?j:L.call(t),x=y[f];",k=0;7>k;k++)r+="n='"+n.h[k]+"';if((!(r&&x[n])&&m.call(t,n))",n.j||(r+="||(!x[n]&&t[n]!==A[n])"),r+="){"+n.g+"}";r+="}"}return(n.b||Et.nonEnumArgs)&&(r+="}"),r+=n.c+";return E",e("d,j,k,m,o,p,q,s,v,A,B,y,I,J,L",t+r+"}")(f,F,Q,rt,L,v,xt,y,V.f,G,$,wt,U,Y,ut)}function p(e){return g(e)?ct(e):{}}function d(e){var t,r;return!e||ut.call(e)!=q||(t=e.constructor,m(t)&&!(t instanceof t))||!Et.argsClass&&v(e)||!Et.nodeClass&&n(e)?!1:Et.ownLast?(At(e,function(e,t,n){return r=rt.call(n,t),!1}),!1!==r):(At(e,function(e,t){r=t}),"undefined"==typeof r||rt.call(e,r))}function v(e){return e&&"object"==typeof e&&"number"==typeof e.length&&ut.call(e)==P||!1}function m(e){return"function"==typeof e}function g(e){return!!e&&!!$[typeof e]}function y(e){return"string"==typeof e||ut.call(e)==U}function b(e,t,n){if(t&&"undefined"==typeof n&&xt(e)){n=-1;for(var r=e.length;++n<r&&!1!==t(e[n],n,e););}else kt(e,t,n);return e}function w(e,t){return 2<arguments.length?c(e,17,gt.call(arguments,2),null,t):c(e,1,null,null,t)}function E(e,t,n){var r,i,s,o,u,a,f,l=0,c=!1,h=!0;if(!m(e))throw new TypeError;if(t=dt(0,t)||0,!0===n)var p=!0,h=!1;else g(n)&&(p=n.leading,c="maxWait"in n&&(dt(t,n.maxWait)||0),h="trailing"in n?n.trailing:h);var d=function(){var n=t-(it()-o);n>0?a=setTimeout(d,n):(i&&clearTimeout(i),n=f,i=a=f=T,n&&(l=it(),s=e.apply(u,r)))},v=function(){a&&clearTimeout(a),i=a=f=T,(h||c!==t)&&(l=it(),s=e.apply(u,r))};return function(){if(r=arguments,o=it(),u=this,f=h&&(a||!p),!1===c)var n=p&&!a;else{i||p||(l=o);var m=c-(o-l);m>0?i||(i=setTimeout(v,m)):(i&&(i=clearTimeout(i)),l=o,s=e.apply(u,r))}return a||t===c||(a=setTimeout(d,t)),n&&(s=e.apply(u,r)),s}}function S(e){return e}function x(e,t,n){var r=null==e,i=null==t;return null==n&&("boolean"==typeof e&&i?(n=e,e=1):i||"boolean"!=typeof t||(n=t,i=!0)),r&&i&&(t=1),e=+e||0,i?(t=e,e=0):t=+t||0,r=mt(),n||e%1||t%1?vt(e+r*(t-e+parseFloat("1e-"+((r+"").length-1))),t):e+et(r*(t-e+1))}var T,N=[],C=0,L={},A=40,O=/\w*$/,M=/^function[ \n\r\t]+\w/,_=/\bthis\b/,D="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),P="[object Arguments]",H="[object Array]",B="[object Boolean]",j="[object Date]",F="[object Error]",I="[object Number]",q="[object Object]",R="[object RegExp]",U="[object String]",z={"[object Function]":!1};z[P]=z[H]=z[B]=z[j]=z[I]=z[q]=z[R]=z[U]=!0;var W={leading:!1,maxWait:0,trailing:!1},X={configurable:!1,enumerable:!1,value:null,writable:!1},V={a:"",b:null,c:"",d:"",e:"",v:null,g:"",h:null,support:null,i:"",j:!1},$={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,"undefined":!1},J=$[typeof t]&&t||this,K=[],Q=Error.prototype,G=Object.prototype,Y=String.prototype,Z=RegExp("^"+(G.valueOf+"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),et=Math.floor,tt=Function.prototype.toString,nt=Z.test(nt=Object.getPrototypeOf)&&nt,rt=G.hasOwnProperty,it=Z.test(it=Date.now)&&it||function(){return+(new Date)},st=K.push,ot=G.propertyIsEnumerable,ut=G.toString,at=K.unshift,ft=function(){try{var e={},t=Z.test(t=Object.defineProperty)&&t,n=t(e,e,e)&&t}catch(r){}return n}(),lt=Z.test(lt=ut.bind)&&lt,ct=Z.test(ct=Object.create)&&ct,ht=Z.test(ht=Array.isArray)&&ht,pt=Z.test(pt=Object.keys)&&pt,dt=Math.max,vt=Math.min,mt=Math.random,gt=K.slice;t=Z.test(J.attachEvent);var yt=lt&&!/\n|true/.test(lt+t),bt={};bt[H]=Array,bt[B]=Boolean,bt[j]=Date,bt["[object Function]"]=Function,bt[q]=Object,bt[I]=Number,bt[R]=RegExp,bt[U]=String;var wt={};wt[H]=wt[j]=wt[I]={constructor:!0,toLocaleString:!0,toString:!0,valueOf:!0},wt[B]=wt[U]={constructor:!0,toString:!0,valueOf:!0},wt[F]=wt["[object Function]"]=wt[R]={constructor:!0,toString:!0},wt[q]={constructor:!0},function(){for(var e=D.length;e--;){var t,n=D[e];for(t in wt)rt.call(wt,t)&&!rt.call(wt[t],n)&&(wt[t][n]=!1)}}();var Et=o.support={};!function(){var e=function(){this.x=1},t={0:1,length:1},n=[];e.prototype={valueOf:1,y:1};for(var r in new e)n.push(r);for(r in arguments);Et.argsClass=ut.call(arguments)==P,Et.argsObject=arguments.constructor==Object&&!(arguments instanceof Array),Et.enumErrorProps=ot.call(Q,"message")||ot.call(Q,"name"),Et.enumPrototypes=ot.call(e,"prototype"),Et.fastBind=lt&&!yt,Et.funcDecomp=!Z.test(J.WinRTError)&&_.test(function(){return this}),Et.funcNames="string"==typeof Function.name,Et.nonEnumArgs=0!=r,Et.nonEnumShadows=!/valueOf/.test(n),Et.ownLast="x"!=n[0],Et.spliceObjects=(K.splice.call(t,0,1),!t[0]),Et.unindexedChars="xx"!="x"[0]+Object("x")[0];try{Et.nodeClass=ut.call(document)!=q||!!({toString:0}+"")}catch(i){Et.nodeClass=!0}}(1),ct||(p=function(e){if(g(e)){r.prototype=e;var t=new r;r.prototype=null}return t||{}});var St=ft?function(e,t){X.value=t,ft(e,"__bindData__",X)}:r;Et.argsClass||(v=function(e){return e&&"object"==typeof e&&"number"==typeof e.length&&rt.call(e,"callee")||!1});var xt=ht||function(e){return e&&"object"==typeof e&&"number"==typeof e.length&&ut.call(e)==H||!1},Tt=h({a:"z",e:"[]",i:"if(!(B[typeof z]))return E",g:"E.push(n)"}),Nt=pt?function(e){return g(e)?Et.enumPrototypes&&"function"==typeof e||Et.nonEnumArgs&&e.length&&v(e)?Tt(e):pt(e):[]}:Tt,ht={a:"g,e,K",i:"e=e&&typeof K=='undefined'?e:d(e,K,3)",b:"typeof u=='number'",v:Nt,g:"if(e(t[n],n,g)===false)return E"};t={a:"z,H,l",i:"var a=arguments,b=0,c=typeof l=='number'?2:a.length;while(++b<c){t=a[b];if(t&&B[typeof t]){",v:Nt,g:"if(typeof E[n]=='undefined')E[n]=t[n]",c:"}}"};var Ct={i:"if(!B[typeof t])return E;"+ht.i,b:!1},kt=h(ht),Lt=h(t,{i:t.i.replace(";",";if(c>3&&typeof a[c-2]=='function'){var e=d(a[--c-1],a[c--],2)}else if(c>2&&typeof a[c-1]=='function'){e=a[--c]}"),g:"E[n]=e?e(E[n],t[n]):t[n]"}),At=h(ht,Ct,{j:!1}),Ot=h(ht,Ct);m(/x/)&&(m=function(e){return"function"==typeof e&&"[object Function]"==ut.call(e)}),ht=nt?function(e){if(!e||ut.call(e)!=q||!Et.argsClass&&v(e))return!1;var t=e.valueOf,n="function"==typeof t&&(n=nt(t))&&nt(n);return n?e==n||nt(e)==n:d(e)}:d,o.assign=Lt,o.bind=w,o.createCallback=function(e,t,n){var r=typeof e;if(null==e||"function"==r)return f(e,t,n);if("object"!=r)return function(t){return t[e]};var i=Nt(e),s=i[0],o=e[s];return 1!=i.length||o!==o||g(o)?function(t){for(var n=i.length,r=!1;n--&&(r=l(t[i[n]],e[i[n]],null,!0)););return r}:function(e){return e=e[s],o===e&&(0!==o||1/o==1/e)}},o.debounce=E,o.forEach=b,o.forIn=At,o.forOwn=Ot,o.keys=Nt,o.shuffle=function(e){var t=-1,n=e?e.length:0,r=Array("number"==typeof n?n:0);return b(e,function(e){var n=x(++t);r[t]=r[n],r[n]=e}),r},o.throttle=function(e,t,n){var r=!0,i=!0;if(!m(e))throw new TypeError;return!1===n?r=!1:g(n)&&(r="leading"in n?n.leading:r,i="trailing"in n?n.trailing:i),W.leading=r,W.maxWait=t,W.trailing=i,E(e,t,W)},o.each=b,o.extend=Lt,o.clone=function(e,t,n,r){return"boolean"!=typeof t&&null!=t&&(r=n,n=t,t=!1),u(e,t,"function"==typeof n&&f(n,r,1))},o.identity=S,o.isArguments=v,o.isArray=xt,o.isFunction=m,o.isObject=g,o.isPlainObject=ht,o.isString=y,o.random=x,o.sortedIndex=function(e,t,n,r){var i=0,s=e?e.length:i;for(n=n?o.createCallback(n,r,1):S,t=n(t);s>i;)r=i+s>>>1,n(e[r])<t?i=r+1:s=r;return i},o.uniqueId=function(e){var t=++C;return(null==e?"":e)+""+t},o.VERSION="2.2.1",o.extend(e.util,o)}(this);var t=e.util.decorator=function(t,n){var r={},i={},s=function(t,n){return e.util.isFunction(n)?n:t},o=Object.getPrototypeOf;"function"!=typeof o&&(o="object"==typeof "test".__proto__?function(e){return e.__proto__}:function(e){return e.constructor.prototype});var u=Object.create;"function"!=typeof u&&(u=function(e){function t(){}return t.prototype=e,new t});var f=function(n,r){return"object"==typeof n?(i=e.util.extend(i,n,s),i.type=t,void 0):("type"!==n&&e.util.isFunction(r)&&(i[n]=r),void 0)};f(n);var l=function(n,f,l,c){var p,v=i;if("string"!=typeof f)c=l,l=f;else{if(v=r[f],!v)throw'Error: "'+f+'" '+t+" not defined";v=v.prototype}if("function"==typeof l)p=r[n],p?p.prototype=e.util.extend(p.prototype,l(o(p.prototype)),s):(p=r[n]=function(e){this.init&&this.init(e)},p.prototype=u(v),p.prototype=e.util.extend(p.prototype,l(v),s)),p.prototype.type=t,p.prototype.name=n;else if(c=l||{},p=r[n],!p)throw'Error: "'+n+'" '+t+" not defined";return c?new p(c):void 0};return l.mixin=f,l};return function(t){var n=t.Physics;e.noConflict=function(){return t.Physics===e&&(t.Physics=n),e}}(this),function(){var t=function n(e){return this instanceof n?(this.initPubsub(e),void 0):new n(e)};t.prototype={initPubsub:function(e){this._topics={},this._defaultScope=e||this},subscribe:function(t,n,r,i){var s,o=this._topics[t]||(this._topics[t]=[]),u=n;if(e.util.isObject(t)){for(var f in t)this.subscribe(f,t[f],n,r);return this}return e.util.isObject(r)?(n=e.util.bind(n,r),n._bindfn_=u):i||(i=r),n._priority_=i,s=e.util.sortedIndex(o,n,"_priority_"),o.splice(s,0,n),this},unsubscribe:function(e,t){if(e===!0)return this._topics={},this;var n,r=this._topics[e];if(!r)return this;if(t===!0)return this._topics[e]=[],this;for(var i=0,s=r.length;s>i;i++)if(n=r[i],n._bindfn_===t||n===t){r.splice(i,1);break}return this},publish:function(e){"object"!=typeof e&&(e={topic:e});var t=e.topic,n=this._topics[t],r=n&&n.length;if(!t)throw"Error: No topic specified in call to world.publish()";if(!r)return this;for(e.scope=e.scope||this._defaultScope;r--;)e.handler=n[r],e.handler(e);return this}},e.util.pubsub=t}(),function(e){for(var t=0,n=["ms","moz","webkit","o"],r=0;r<n.length&&!e.requestAnimationFrame;++r)e.requestAnimationFrame=e[n[r]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[n[r]+"CancelAnimationFrame"]||e[n[r]+"CancelRequestAnimationFrame"];e.requestAnimationFrame||(e.requestAnimationFrame=function(n){var r=(new Date).getTime(),i=Math.max(0,16-(r-t)),s=e.setTimeout(function(){n(r+i)},i);return t=r+i,s}),e.cancelAnimationFrame||(e.cancelAnimationFrame=function(e){clearTimeout(e)})}(this),function(){var t=100,n=10,r="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",i="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",s="Error: Too many scratchpads created. (Did you forget to call .done()?)",o=[],u=0,f=function(){if(this.objIndex=0,this.arrayIndex=0,this.vectorIndex=0,this.aabbIndex=0,this.transformIndex=0,this.objectStack=[],this.arrayStack=[],this.vectorStack=[],this.aabbStack=[],this.transformStack=[],++u>=t)throw s};f.prototype={done:function(){this._active=!1,this.objIndex=this.arrayIndex=this.vectorIndex=this.aabbIndex=this.transformIndex=0,o.push(this)},object:function(){var e=this.objectStack;if(!this._active)throw r;if(this.objIndex>=n)throw i;return e[this.objIndex++]||e[e.push({})-1]},array:function(){var e=this.arrayStack;if(!this._active)throw r;if(this.arrIndex>=n)throw i;return e[this.arrIndex++]||e[e.push([])-1]},vector:function(){var t=this.vectorStack;if(!this._active)throw r;if(this.vectorIndex>=n)throw i;return t[this.vectorIndex++]||t[t.push(e.vector())-1]},aabb:function(){var t=this.aabbStack;if(!this._active)throw r;if(this.aabbIndex>=n)throw i;return t[this.aabbIndex++]||t[t.push(e.aabb())-1]},transform:function(){var t=this.transformStack;if(!this._active)throw r;if(this.transformIndex>=n)throw i;return t[this.transformIndex++]||t[t.push(e.transform())-1]}},e.scratchpad=function(){var e=o.pop()||new f;return e._active=!0,e}}(),function(t){function n(e){var r=c;if(l){t.requestAnimationFrame(n);for(var i=0,s=r.length;s>i;++i)r[i](e,e-f);f=e}}function r(){return f=(new Date).getTime(),l=!0,n(),this}function i(){return l=!1,this}function s(e){if("function"==typeof e){for(var t=0,n=c.length;n>t;++t)if(e===c[t])return this;c.push(e)}return this}function o(e){for(var t=c,n=0,r=t.length;r>n;++n)if(t[n]===e)return t.splice(n,1),this;return this}function u(){return!!l}var f=0,l=!1,c=[];e.util.ticker={start:r,stop:i,subscribe:s,unsubscribe:o,isActive:u}}(this),function(){var t=function n(t,r,i,s){return this instanceof n?(this._pos=e.vector(),this.set(t,r,i,s),void 0):new n(t,r,i,s)};t.prototype.set=function(t,n,r,i){return e.util.isObject(t)?(this._pos.clone(t.pos),this._hw=t.halfWidth,this._hh=t.halfHeight,this):(this._pos.set(.5*(r+t),.5*(i+n)),this._hw=.5*(r-t),this._hh=.5*(i-n),this)},t.prototype.get=function(){var e=this.halfWidth(),t=this.halfHeight();return{pos:this._pos.values(),halfWidth:e,halfHeight:t,x:e,y:t}},t.prototype.halfWidth=function(){return this._hw},t.prototype.halfHeight=function(){return this._hh},t.prototype.contains=function(e){var t=void 0!==e.x?e.x:e.get(0),n=void 0!==e.y?e.y:e.get(1);return t>this._pos.get(0)-this._hw&&t<this._pos.get(0)+this._hw&&n>this._pos.get(1)-this._hh&&n<this._pos.get(1)+this._hh},t.prototype.transform=function(t){var n=this._hw,r=this._hh,i=e.scratchpad(),s=i.vector().set(n,r),o=i.vector().set(n,-r);return this._pos.translate(t),s.rotate(t),o.rotate(t),this._hw=Math.max(Math.abs(s.get(0)),Math.abs(o.get(0))),this._hh=Math.max(Math.abs(s.get(1)),Math.abs(o.get(1))),i.done(),this},t.contains=function(e,t){var n=void 0!==t.x?t.x:t.get(0),r=void 0!==t.y?t.y:t.get(1);return e=e.get?e.get():e,n>e.pos.x-e.halfWidth&&n<e.pos.x+e.halfWidth&&r>e.pos.y-e.halfHeight&&r<e.pos.y+e.halfHeight},e.aabb=t}(),function(){var t=1e-4,n=100,r=function(e,t,n){var r=t.normSq()-t.dot(e),i=t.dot(e)-e.normSq();return 0>r?n.clone(t).negate():i>0?n.clone(e).negate():(n.clone(t).vsub(e),n.perp(e.cross(n)<0))},i=function(t){var n,r,i=t.length,s=t[i-2],o=t[i-3],u=e.scratchpad(),f=u.vector().clone(s.pt),l=u.vector().clone(o.pt).vsub(f);if(l.equals(e.vector.zero))return u.done(),{a:s.a,b:s.b};if(n=-l.dot(f)/l.normSq(),r=1-n,0>=r)return u.done(),{a:o.a,b:o.b};if(0>=n)return u.done(),{a:s.a,b:s.b};var c={a:f.clone(s.a).mult(r).vadd(l.clone(o.a).mult(n)).values(),b:f.clone(s.b).mult(r).vadd(l.clone(o.b).mult(n)).values()};return u.done(),c},s=function(s,o,u,f){var l,h,p,v,m=!1,g=!1,y=!1,w=[],E=1,S=e.scratchpad(),x=S.vector().clone(o||e.vector.axis[0]),T=S.vector(),N=S.vector(),C=S.vector(),k=S.vector(),L=0;for(v=s(x),E=w.push(v),T.clone(v.pt),x.negate();++L;){if(T.swap(N),v=s(x),E=w.push(v),T.clone(v.pt),f&&f(w),T.equals(e.vector.zero)){m=!0;break}if(!g&&T.dot(x)<=0){if(u)break;g=!0}if(2===E)x=r(T,N,x);else if(g){if(x.normalize(),v=N.dot(x),Math.abs(v-T.dot(x))<t){y=-v;break}N.normSq()<C.clone(w[0].pt).normSq()?w.shift():w.splice(1,1),x=r(C.clone(w[1].pt),k.clone(w[0].pt),x)}else if(l=l||S.vector(),h=h||S.vector(),l.clone(N).vsub(T),h.clone(w[0].pt).vsub(T),p=l.cross(h)>0,p^T.cross(l)>0)w.shift(),l.perp(p),x.swap(l);else{if(!(p^h.cross(T)>0)){m=!0;break}w.splice(1,1),h.perp(!p),x.swap(l)}if(L>n)return S.done(),{simplex:w,iterations:L,distance:0,maxIterationsReached:!0}}return S.done(),v={overlap:m,simplex:w,iterations:L},y!==!1&&(v.distance=y,v.closest=i(w)),v};e.gjk=s}(),function(){var t=function n(t,r,i){return this instanceof n?(this.v=e.vector(),this.o=e.vector(),t instanceof n?(this.clone(t),void 0):(t&&this.setTranslation(t),this.setRotation(r||0,i),void 0)):new n(t,r)};t.prototype.setTranslation=function(e){return this.v.clone(e),this},t.prototype.setRotation=function(e,t){return this.cosA=Math.cos(e),this.sinA=Math.sin(e),t?this.o.clone(t):this.o.zero(),this},t.prototype.clone=function(e){return e?(this.setTranslation(e.v),this.cosA=e.cosA,this.sinA=e.sinA,this.o.clone(e.o),this):new t(this)},e.transform=t}(),function(t){var n=Math.sqrt,r=Math.min,i=Math.max,s=(Math.acos,Math.atan2),o=2*Math.PI,u=!!t.Float64Array,f=function l(e,t){return this instanceof l?(this._=u?new Float64Array(5):[],e&&(void 0!==e.x||e._&&e._.length)?this.clone(e):(this.recalc=!0,this.set(e||0,t||0)),void 0):new l(e,t)};f.prototype.set=function(e,t){return this.recalc=!0,this._[0]=e||0,this._[1]=t||0,this},f.prototype.get=function(e){return this._[e]},f.prototype.vadd=function(e){return this.recalc=!0,this._[0]+=e._[0],this._[1]+=e._[1],this},f.prototype.vsub=function(e){return this.recalc=!0,this._[0]-=e._[0],this._[1]-=e._[1],this},f.prototype.add=function(e,t){return this.recalc=!0,this._[0]+=e,this._[1]+=void 0===t?e:t,this},f.prototype.sub=function(e,t){return this.recalc=!0,this._[0]-=e,this._[1]-=void 0===t?e:t,this},f.prototype.mult=function(e){return this.recalc||(this._[4]*=e*e,this._[3]*=e),this._[0]*=e,this._[1]*=e,this},f.prototype.dot=function(e){return this._[0]*e._[0]+this._[1]*e._[1]},f.prototype.cross=function(e){return-this._[0]*e._[1]+this._[1]*e._[0]},f.prototype.proj=function(e){return this.dot(e)/e.norm()},f.prototype.vproj=function(e){var t=this.dot(e)/e.normSq();return this.clone(e).mult(t)},f.prototype.angle=function(e){var t;if(this.equals(f.zero))return e?e.angle():0/0;for(t=e&&!e.equals(f.zero)?s(this._[1]*e._[0]-this._[0]*e._[1],this._[0]*e._[0]+this._[1]*e._[1]):s(this._[1],this._[0]);t>Math.PI;)t-=o;for(;t<-Math.PI;)t+=o;return t},f.prototype.angle2=function(e,t){for(var n=e._[0]-this._[0],r=e._[1]-this._[1],i=t._[0]-this._[0],u=t._[1]-this._[1],a=s(r*i-n*u,n*i+r*u);a>Math.PI;)a-=o;for(;a<-Math.PI;)a+=o;return a},f.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=n(this._[4])),this._[3]},f.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=n(this._[4])),this._[4]},f.prototype.dist=function(e){var t,r;return n((t=e._[0]-this._[0])*t+(r=e._[1]-this._[1])*r)},f.prototype.distSq=function(e){var t,n;return(t=e._[0]-this._[0])*t+(n=e._[1]-this._[1])*n},f.prototype.perp=function(e){var t=this._[0];return e?(this._[0]=-this._[1],this._[1]=t):(this._[0]=this._[1],this._[1]=-t),this},f.prototype.normalize=function(){var e=this.norm();return 0===e?this:(e=1/e,this._[0]*=e,this._[1]*=e,this._[3]=1,this._[4]=1,this)},f.prototype.transform=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r,this._[1]-=i,this.set(this._[0]*n-this._[1]*t+r+e.v._[0],this._[0]*t+this._[1]*n+i+e.v._[1])},f.prototype.transformInv=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r+e.v._[0],this._[1]-=i+e.v._[1],this.set(this._[0]*n+this._[1]*t+r,-this._[0]*t+this._[1]*n+i)},f.prototype.rotate=function(e,t){var n,r,i=0,s=0;return"number"==typeof e?(n=Math.sin(e),r=Math.cos(e),t&&(i=0|(t.x||t._[0]),s=0|(t.y||t._[1]))):(n=e.sinA,r=e.cosA,i=e.o._[0],s=e.o._[1]),this._[0]-=i,this._[1]-=s,this.set(this._[0]*r-this._[1]*n+i,this._[0]*n+this._[1]*r+s)},f.prototype.rotateInv=function(e){return this.set((this._[0]-e.o._[0])*e.cosA+(this._[1]-e.o._[1])*e.sinA+e.o._[0],-(this._[0]-e.o._[0])*e.sinA+(this._[1]-e.o._[1])*e.cosA+e.o._[1])},f.prototype.translate=function(e){return this.vadd(e.v)},f.prototype.translateInv=function(e){return this.vsub(e.v)},f.prototype.clone=function(e){return e?e._?(this.recalc=e.recalc,e.recalc||(this._[3]=e._[3],this._[4]=e._[4]),this._[0]=e._[0],this._[1]=e._[1],this):this.set(e.x,e.y):new f(this)},f.prototype.swap=function(e){var t=this._;return this._=e._,e._=t,t=this.recalc,this.recalc=e.recalc,e.recalc=t,this},f.prototype.values=function(){return{x:this._[0],y:this._[1]}},f.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},f.prototype.negate=function(e){return void 0!==e?(this._[e]=-this._[e],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},f.prototype.clamp=function(e,t){return e=e.values?e.values():e,t=t.values?t.values():t,this._[0]=r(i(this._[0],e.x),t.x),this._[1]=r(i(this._[1],e.y),t.y),this.recalc=!0,this},f.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},f.prototype.equals=function(e){return this._[0]===e._[0]&&this._[1]===e._[1]&&this._[2]===e._[2]},f.vadd=function(e,t){return new f(e._[0]+t._[0],e._[1]+t._[1])},f.vsub=function(e,t){return new f(e._[0]-t._[0],e._[1]-t._[1])},f.mult=function(e,t){return new f(t._[0]*e,t._[1]*e)},f.vproj=function(e,t){return f.mult(e.dot(t)/t.normSq(),t)},f.axis=[new f(1,0),new f(0,1)],f.zero=new f(0,0),e.vector=f}(this),function(){e.behavior=e.behaviour=t("behavior",{priority:0,init:function(){this.options={}},connect:function(e){this.behave&&e.subscribe("integrate:positions",this.behave,this,this.priority)},disconnect:function(e){this.behave&&e.unsubscribe("integrate:positions",this.behave)},behave:null})}(),function(){var n={fixed:!1,mass:1,restitution:1,cof:.8,view:null};e.body=t("body",{init:function(t){var r=e.vector;if(this.options=e.util.extend({},n,t),this.fixed=this.options.fixed,this.hidden=this.options.hidden,this.mass=this.options.mass,this.restitution=this.options.restitution,this.cof=this.options.cof,this.view=this.options.view,this.state={pos:r(t.x,t.y),vel:r(t.vx,t.vy),acc:r(),angular:{pos:t.angle||0,vel:t.angularVelocity||0,acc:0},old:{pos:r(),vel:r(),acc:r(),angular:{pos:0,vel:0,acc:0}}},0===this.mass)throw"Error: Bodies must have non-zero mass";this.geometry=e.geometry("point")},accelerate:function(e){return this.state.acc.vadd(e),this},applyForce:function(t,n){var r,i=e.scratchpad(),s=i.vector();return n?this.moi&&(r=this.state,s.clone(n),this.state.angular.acc-=s.cross(t)/this.moi,this.applyForce(t)):this.accelerate(s.clone(t).mult(1/this.mass)),i.done(),this},aabb:function(){var t=e.scratchpad(),n=t.transform(),r=this.state.angular.pos,i=t.aabb().set(this.geometry.aabb(r));return n.setRotation(0).setTranslation(this.state.pos),i.transform(n),i=i.get(),t.done(),i},recalc:function(){}})}(),function(){e.geometry=t("geometry",{init:function(){this._aabb=new e.aabb},aabb:function(){return this._aabb.get()},getFarthestHullPoint:function(t,n){return n=n||e.vector(),n.set(0,0)},getFarthestCorePoint:function(t,n){return n=n||e.vector(),n.set(0,0)}})}(),e.geometry.isPolygonConvex=function(t){var n=e.scratchpad(),r=n.vector(),i=n.vector(),s=n.vector(),o=!0,u=!1,f=t.length;if(!t||!f)return!1;if(3>f)return n.done(),o;r.clone(t[0]).vsub(s.clone(t[f-1]));for(var l=1;f>=l;++l){if(i.clone(t[l%f]).vsub(s.clone(t[(l-1)%f])),u===!1)u=r.cross(i);else if(u>0^r.cross(i)>0){o=!1;break}i.swap(r)}return n.done(),o},e.geometry.getPolygonMOI=function(t){var n,r=e.scratchpad(),i=r.vector(),s=r.vector(),o=0,u=0,f=t.length;if(2>f)return r.done(),0;if(2===f)return n=s.clone(t[1]).distSq(i.clone(t[0])),r.done(),n/12;i.clone(t[0]);for(var l=1;f>l;++l)s.clone(t[l]),n=Math.abs(s.cross(i)),o+=n*(s.normSq()+s.dot(i)+i.normSq()),u+=n,i.swap(s);return r.done(),o/(6*u)},e.geometry.isPointInPolygon=function(t,n){var r=e.scratchpad(),i=r.vector().clone(t),s=r.vector(),o=r.vector(),u=0,f=n.length;if(2>f)return u=i.equals(s.clone(n[0])),r.done(),u;if(2===f)return u=i.angle(s.clone(n[0])),u+=i.angle(s.clone(n[1])),r.done(),Math.abs(u)===Math.PI;s.clone(n[0]).vsub(i);for(var l=1;f>=l;++l)o.clone(n[l%f]).vsub(i),u+=o.angle(s),s.swap(o);return r.done(),Math.abs(u)>0},e.geometry.getPolygonArea=function(t){var n=e.scratchpad(),r=n.vector(),i=n.vector(),s=0,o=t.length;if(3>o)return n.done(),0;r.clone(t[o-1]);for(var u=0;o>u;++u)i.clone(t[u]),s+=r.cross(i),r.swap(i);return n.done(),s/2},e.geometry.getPolygonCentroid=function(t){var n,r=e.scratchpad(),i=r.vector(),s=r.vector(),o=e.vector(),u=t.length;if(2>u)return r.done(),e.vector(t[0]);if(2===u)return r.done(),e.vector((t[1].x+t[0].x)/2,(t[1].y+t[0].y)/2);i.clone(t[u-1]);for(var f=0;u>f;++f)s.clone(t[f]),n=i.cross(s),i.vadd(s).mult(n),o.vadd(i),i.swap(s);return n=1/(6*e.geometry.getPolygonArea(t)),r.done(),o.mult(n)},e.geometry.nearestPointOnLine=function(t,n,r){var i,s,o=e.scratchpad(),u=o.vector().clone(t),f=o.vector().clone(n).vsub(u),l=o.vector().clone(r).vsub(u).vsub(f);return l.equals(e.vector.zero)?(o.done(),e.vector(n)):(i=-l.dot(f)/l.normSq(),s=1-i,0>=s?(o.done(),e.vector(r)):0>=i?(o.done(),e.vector(n)):(u=e.vector(r).mult(i).vadd(f.clone(n).mult(s)),o.done(),u))},function(){var n={drag:0};e.integrator=t("integrator",{init:function(t){this.options=e.util.extend({},n,t)},integrate:function(e,t){var n=this._world;return this.integrateVelocities(e,t),n&&n.publish({topic:"integrate:velocities",bodies:e,dt:t}),this.integratePositions(e,t),n&&n.publish({topic:"integrate:positions",bodies:e,dt:t}),this},integrateVelocities:function(){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var n={meta:!1,metaRefresh:200,width:600,height:600};e.renderer=t("renderer",{init:function(t){var r="string"==typeof t.el?document.getElementById(t.el):t.el;this.options=e.util.extend({},n,t),this.el=r?r:document.body,this.drawMeta=e.util.throttle(e.util.bind(this.drawMeta,this),this.options.metaRefresh)},render:function(e,t){var n,r;this.beforeRender&&this.beforeRender(),this._world.publish({topic:"beforeRender",renderer:this,bodies:e,stats:t}),this.options.meta&&this.drawMeta(t);for(var i=0,s=e.length;s>i;++i)n=e[i],r=n.view||(n.view=this.createView(n.geometry)),n.hidden||this.drawBody(n,r);return this},createView:function(){throw"You must overried the renderer.createView() method."},drawMeta:function(){throw"You must overried the renderer.drawMeta() method."},drawBody:function(){throw"You must overried the renderer.drawBody() method."}})}(),function(){var t=function(e){this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e)};e.util.each("body,behavior,integrator,renderer".split(","),function(n){e[n].mixin("setWorld",t)});var n=function s(e,t,n){for(var r,i,o=function(){return s(e,t,n)};r=e.shift();)if(i=r.apply(t,n),i&&i.then)return i.then(o)},r={timestep:6.25,maxIPF:16,webworker:!1,integrator:"verlet"},i=function o(e,t){return this instanceof o?(this.init(e,t),void 0):new o(e,t)};i.prototype=e.util.extend({},e.util.pubsub.prototype,{init:function(t,r){(e.util.isFunction(t)||e.util.isArray(t))&&(r=t,t={}),this._stats={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._opts={},this.initPubsub(this),this.options(t||{}),e.util.isFunction(r)?n([r],this,[this,e]):e.util.isArray(r)&&n(r,this,[this,e])},options:function(t){return t?(e.util.extend(this._opts,r,t),this.timeStep(this._opts.timestep),this.add(e.integrator(this._opts.integrator)),this):e.util.clone(this._opts)},add:function(e){var t,n=0,r=e&&e.length||0,i=r?e[0]:e;if(!i)return this;do{switch(i.type){case"behavior":this.addBehavior(i);break;case"integrator":this.integrator(i);break;case"renderer":this.renderer(i);break;case"body":this.addBody(i);break;default:throw'Error: failed to add item of unknown type "'+i.type+'" to world'}t={topic:"add:"+i.type},t[i.type]=i,this.publish(t)}while(++n<r&&(i=e[n]));return this},remove:function(e){var t,n=0,r=e&&e.length||0,i=r?e[0]:e;if(!i)return this;do{switch(i.type){case"behavior":this.removeBehavior(i);break;case"integrator":i===this._integrator&&this.integrator(null);break;case"renderer":i===this._renderer&&this.renderer(null);break;case"body":this.removeBody(i);break;default:throw'Error: failed to remove item of unknown type "'+i.type+'" from world'}t={topic:"add:"+i.type},t[i.type]=i,this.publish(t)}while(++n<r&&(i=e[n]));return this},integrator:function(e){return void 0===e?this._integrator:(this._integrator&&this._integrator.setWorld(null),e&&(this._integrator=e,this._integrator.setWorld(this)),this)},renderer:function(e){return void 0===e?this._renderer:(this._renderer&&this._renderer.setWorld(null),e&&(this._renderer=e,this._renderer.setWorld(this)),this)},timeStep:function(e){return e?(this._dt=e,this._maxJump=e*this._opts.maxIPF,this):this._dt},addBehavior:function(e){return e.setWorld(this),this._behaviors.push(e),this},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(e){var t,n=this._behaviors;if(e){for(var r=0,i=n.length;i>r;++r)if(e===n[r]){n.splice(r,1);break}t={topic:"remove:behavior"},t.behavior=e,this.publish(t)}return this},addBody:function(e){return e.setWorld(this),this._bodies.push(e),this},getBodies:function(){return[].concat(this._bodies)},removeBody:function(e){var t,n=this._bodies;if(e){for(var r=0,i=n.length;i>r;++r)if(e===n[r]){n.splice(r,1);break}t={topic:"remove:body"},t.body=e,this.publish(t)}return this},findOne:function(t){var n={check:function(e){for(var t=this;t=t.next;)if(t(e))return!0;return!1}},r=n,i=this._bodies;t.$within,t.$at&&(r.next=function(n){var r=n.aabb();return e.aabb.contains(r,t.$at)});for(var s=0,o=i.length;o>s;++s)if(n.check(i[s]))return i[s];return!1},iterate:function(e){this._integrator.integrate(this._bodies,e)},step:function(e){if(this._paused)return this._time=!1,this;var t=this._time||(this._time=e),n=e-t,r=this._stats,i=this._dt;if(!n)return this;for(n>this._maxJump&&(this._time=e-this._maxJump,n=this._maxJump),r.fps=1e3/n,r.ipf=Math.ceil(n/this._dt);this._time<e;)this._time+=i,this.iterate(i);return this.publish({topic:"step"}),this},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._stats),this.publish({topic:"render",bodies:this._bodies,stats:this._stats,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.publish({topic:"pause"}),this},unpause:function(){return this._paused=!1,this.publish({topic:"unpause"}),this},isPaused:function(){return!!this._paused},destroy:function(){var e=this;e.pause(),e.unsubscribe(!0),e.remove(e.getBodies()),e.remove(e.getBehaviors()),e.integrator(null),e.renderer(null)}}),e.world=i}(),e.integrator("verlet",function(t){return e.body.mixin({started:function(e){return void 0!==e&&(this._started=!0),!!this._started}}),{init:function(e){t.init.call(this,e)},integrateVelocities:function(e,t){for(var n,r=t*t,i=1-this.options.drag,s=null,o=0,u=e.length;u>o;++o)s=e[o],n=s.state,s.fixed?(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0):(n.vel.equals(n.old.vel)&&s.started()?n.vel.clone(n.pos).vsub(n.old.pos):(n.old.pos.clone(n.pos).vsub(n.vel),n.vel.mult(t)),i&&n.vel.mult(i),n.vel.vadd(n.acc.mult(r)),n.vel.mult(1/t),n.old.vel.clone(n.vel),n.acc.zero(),n.angular.vel===n.old.angular.vel&&s.started()?n.angular.vel=n.angular.pos-n.old.angular.pos:(n.old.angular.pos=n.angular.pos-n.angular.vel,n.angular.vel*=t),n.angular.vel+=n.angular.acc*r,n.angular.vel/=t,n.old.angular.vel=n.angular.vel,n.angular.acc=0,s.started(!0))},integratePositions:function(e,t){for(var n,r=null,i=0,s=e.length;s>i;++i)r=e[i],n=r.state,r.fixed||(n.vel.mult(t),n.old.pos.clone(n.pos),n.pos.vadd(n.vel),n.vel.mult(1/t),n.old.vel.clone(n.vel),n.angular.vel*=t,n.old.angular.pos=n.angular.pos,n.angular.pos+=n.angular.vel,n.angular.vel/=t,n.old.angular.vel=n.angular.vel)}}}),e.geometry("point",function(){}),e.geometry("circle",function(t){var n={radius:1};return{init:function(r){t.init.call(this,r),r=e.util.extend({},n,r),this.radius=r.radius,this._aabb=e.aabb()},aabb:function(){var e=this.radius,t=this._aabb;return t.halfWidth()===e?t.get():t.set(-e,-e,e,e).get()},getFarthestHullPoint:function(t,n){return n=n||e.vector(),n.clone(t).normalize().mult(this.radius)},getFarthestCorePoint:function(t,n,r){return n=n||e.vector(),n.clone(t).normalize().mult(this.radius-r)}}}),e.geometry("convex-polygon",function(t){var n="Error: The vertices specified do not match that of a _convex_ polygon.",r={};return{init:function(n){t.init.call(this,n),n=e.util.extend({},r,n),this.setVertices(n.vertices||[])},setVertices:function(t){var r=e.scratchpad(),i=r.transform(),s=this.vertices=[];if(!e.geometry.isPolygonConvex(t))throw n;i.setRotation(0),i.setTranslation(e.geometry.getPolygonCentroid(t).negate());for(var o=0,u=t.length;u>o;++o)s.push(e.vector(t[o]).translate(i));return this._area=e.geometry.getPolygonArea(s),this._aabb=!1,r.done(),this},aabb:function(t){if(!t&&this._aabb)return this._aabb.get();var n,r=e.scratchpad(),i=r.vector(),s=r.transform().setRotation(t||0),o=r.vector().clone(e.vector.axis[0]).rotateInv(s),u=r.vector().clone(e.vector.axis[1]).rotateInv(s),f=this.getFarthestHullPoint(o,i).proj(o),l=-this.getFarthestHullPoint(o.negate(),i).proj(o),c=this.getFarthestHullPoint(u,i).proj(u),h=-this.getFarthestHullPoint(u.negate(),i).proj(u);return n=new e.aabb(l,h,f,c),t||(this._aabb=n),r.done(),n.get()},getFarthestHullPoint:function(t,n,r){var i,s,o,u=this.vertices,f=u.length,l=2;if(n=n||e.vector(),2>f)return r&&(r.idx=0),n.clone(u[0]);if(s=u[0].dot(t),i=u[1].dot(t),2===f)return o=i>=s?1:0,r&&(r.idx=o),n.clone(u[o]);if(i>=s){for(;f>l&&i>=s;)s=i,i=u[l].dot(t),l++;return i>=s&&l++,o=l-2,r&&(r.idx=l-2),n.clone(u[o])}for(l=f;l>2&&s>=i;)l--,i=s,s=u[l].dot(t);return o=(l+1)%f,r&&(r.idx=o),n.clone(u[o])},getFarthestCorePoint:function(t,n,r){var i,s=e.scratchpad(),o=s.vector(),u=s.vector(),f=this.vertices,l=f.length,c=this._area>0,h={};return n=this.getFarthestHullPoint(t,n,h),o.clone(f[(h.idx+1)%l]).vsub(n).normalize().perp(!c),u.clone(f[(h.idx-1+l)%l]).vsub(n).normalize().perp(c),i=r/(1+o.dot(u)),n.vadd(o.vadd(u).mult(i)),s.done(),n}}}),e.body("circle",function(t){var n={radius:1};return{init:function(r){t.init.call(this,r),r=e.util.extend({},n,r),this.geometry=e.geometry("circle",{radius:r.radius}),this.recalc()},recalc:function(){t.recalc.call(this),this.moi=this.mass*this.geometry.radius*this.geometry.radius/2}}}),e.body("convex-polygon",function(t){var n={};return{init:function(r){t.init.call(this,r),r=e.util.extend({},n,r),this.geometry=e.geometry("convex-polygon",{vertices:r.vertices}),this.recalc()},recalc:function(){t.recalc.call(this),this.moi=e.geometry.getPolygonMOI(this.geometry.vertices)}}}),e.body("point",function(){}),e.behavior("body-collision-detection",function(t){var n="collisions:candidates",r="collisions:detected",i=function(t,n){var r;return r=function(i){var s,o=e.scratchpad(),u=o.transform().setTranslation(t.state.pos).setRotation(t.state.angular.pos),f=o.transform().setTranslation(n.state.pos).setRotation(n.state.angular.pos),l=o.vector(),h=o.vector(),p=r.useCore?"getFarthestCorePoint":"getFarthestHullPoint",v=r.marginA,m=r.marginB;return l=t.geometry[p](i.rotateInv(u),l,v).transform(u),h=n.geometry[p](i.rotate(u).rotateInv(f).negate(),h,m).transform(f),i.negate().rotate(f),s={a:l.values(),b:h.values(),pt:l.vsub(h).values()},o.done(),s},r.useCore=!1,r.margin=0,r},s=function(t,n){var r,s,o,u=e.scratchpad(),f=u.vector(),l=u.vector(),c=!1,h=t.aabb(),p=Math.min(h.halfWidth,h.halfHeight),d=n.aabb(),v=Math.min(d.halfWidth,d.halfHeight);if(o=i(t,n),f.clone(t.state.pos).vsub(n.state.pos),s=e.gjk(o,f,!0),s.overlap){for(c={bodyA:t,bodyB:n},o.useCore=!0,o.marginA=0,o.marginB=0;s.overlap&&(o.marginA<p||o.marginB<v);)o.marginA<p&&(o.marginA+=1),o.marginB<v&&(o.marginB+=1),s=e.gjk(o,f);if(s.overlap||s.maxIterationsReached)return u.done(),!1;r=Math.max(0,o.marginA+o.marginB-s.distance),c.overlap=r,c.norm=f.clone(s.closest.b).vsub(l.clone(s.closest.a)).normalize().values(),c.mtv=f.mult(r).values(),c.pos=f.clone(c.norm).mult(o.margin).vadd(l.clone(s.closest.a)).vsub(t.state.pos).values()}return u.done(),c},o=function(t,n){var r,i=e.scratchpad(),s=i.vector(),o=(i.vector(),!1);return s.clone(n.state.pos).vsub(t.state.pos),r=s.norm()-(t.geometry.radius+n.geometry.radius),s.equals(e.vector.zero)&&s.set(1,0),0>=r&&(o={bodyA:t,bodyB:n,norm:s.normalize().values(),mtv:s.mult(-r).values(),pos:s.normalize().mult(t.geometry.radius).values(),overlap:-r}),i.done(),o},u=function(e,t){return"circle"===e.geometry.name&&"circle"===t.geometry.name?o(e,t):s(e,t)},f={checkAll:!1};return{init:function(n){t.init.call(this,n),this.options=e.util.extend({},this.options,f,n)},connect:function(e){this.options.checkAll?e.subscribe("integrate:velocities",this.checkAll,this):e.subscribe(n,this.check,this)},disconnect:function(e){this.options.checkAll?e.unsubscribe("integrate:velocities",this.checkAll):e.unsubscribe(n,this.check)},check:function(e){for(var t,n,i=e.candidates,s=[],o=0,a=i.length;a>o;++o)t=i[o],n=u(t.bodyA,t.bodyB),n&&s.push(n);s.length&&this._world.publish({topic:r,collisions:s})},checkAll:function(e){for(var t,n,i,s=e.bodies,o=(e.dt,[]),a=0,f=s.length;f>a;a++){t=s[a];for(var l=a+1;f>l;l++)n=s[l],t.fixed&&n.fixed||(i=u(t,n),i&&o.push(i))}o.length&&this._world.publish({topic:r,collisions:o})}}}),e.behavior("body-impulse-response",function(){var t="collisions:detected";return{connect:function(e){e.subscribe(t,this.respond,this)},disconnect:function(e){e.unsubscribe(t,this.respond)},collideBodies:function(t,n,r,i,s,o){var u=t.fixed,f=n.fixed,l=e.scratchpad(),c=l.vector().clone(s);if(u&&f)return l.done(),void 0;u?n.state.pos.vadd(c):f?t.state.pos.vsub(c):(c.mult(.5),t.state.pos.vsub(c),n.state.pos.vadd(c));var h,p,d,v=u?0:1/t.moi,m=f?0:1/n.moi,g=u?0:1/t.mass,y=f?0:1/n.mass,b=o?0:t.restitution*n.restitution,w=t.cof*n.cof,E=l.vector().clone(r),S=l.vector().clone(E).perp(!0),x=l.vector().clone(i),T=l.vector().clone(i).vadd(t.state.pos).vsub(n.state.pos),N=l.vector(),C=t.state.angular.vel,k=n.state.angular.vel,L=l.vector().clone(n.state.vel).vadd(N.clone(T).perp(!0).mult(k)).vsub(t.state.vel).vsub(N.clone(x).perp(!0).mult(C)),A=x.proj(E),O=x.proj(S),M=T.proj(E),_=T.proj(S),D=L.proj(E),P=L.proj(S),H=!1;return D>=0?(l.done(),void 0):(h=-((1+b)*D)/(g+y+v*O*O+m*_*_),u?(n.state.vel.vadd(E.mult(h*y)),n.state.angular.vel-=h*m*_):f?(t.state.vel.vsub(E.mult(h*g)),t.state.angular.vel+=h*v*O):(n.state.vel.vadd(E.mult(h*y)),n.state.angular.vel-=h*m*_,t.state.vel.vsub(E.mult(g*n.mass)),t.state.angular.vel+=h*v*O),w&&P&&(d=P/(g+y+v*A*A+m*M*M),H?h=d:(p=0>P?-1:1,h*=p*w,h=1===p?Math.min(h,d):Math.max(h,d)),u?(n.state.vel.vsub(S.mult(h*y)),n.state.angular.vel-=h*m*M):f?(t.state.vel.vadd(S.mult(h*g)),t.state.angular.vel+=h*v*A):(n.state.vel.vsub(S.mult(h*y)),n.state.angular.vel-=h*m*M,t.state.vel.vadd(S.mult(g*n.mass)),t.state.angular.vel+=h*v*A)),l.done(),void 0)},respond:function(t){for(var n,r=this,i=e.util.shuffle(t.collisions),s=0,o=i.length;o>s;++s)n=i[s],r.collideBodies(n.bodyA,n.bodyB,n.norm,n.pos,n.mtv)}}}),e.behavior("constant-acceleration",function(t){var n={acc:{x:0,y:4e-4}};return{init:function(r){t.init.call(this,r),this.options=e.util.extend(this.options,n,r),this._acc=e.vector(),this.setAcceleration(this.options.acc)},setAcceleration:function(e){return this._acc.clone(e),this},behave:function(e){for(var t=e.bodies,n=0,r=t.length;r>n;++n)t[n].accelerate(this._acc)}}}),e.behavior("edge-collision-detection",function(t){var n="collisions:detected",r=function(t,n,r){var i,s=t.aabb(),o=e.scratchpad(),u=o.transform(),f=o.vector(),l=o.vector(),c=!1,h=[];return i=s.pos.x+s.x-n.max.x,i>=0&&(f.set(1,0).rotateInv(u.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:r,overlap:i,norm:{x:1,y:0},mtv:{x:i,y:0},pos:t.geometry.getFarthestHullPoint(f,l).rotate(u).values()},h.push(c)),i=s.pos.y+s.y-n.max.y,i>=0&&(f.set(0,1).rotateInv(u.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:r,overlap:i,norm:{x:0,y:1},mtv:{x:0,y:i},pos:t.geometry.getFarthestHullPoint(f,l).rotate(u).values()},h.push(c)),i=n.min.x-(s.pos.x-s.x),i>=0&&(f.set(-1,0).rotateInv(u.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:r,overlap:i,norm:{x:-1,y:0},mtv:{x:-i,y:0},pos:t.geometry.getFarthestHullPoint(f,l).rotate(u).values()},h.push(c)),i=n.min.y-(s.pos.y-s.y),i>=0&&(f.set(0,-1).rotateInv(u.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:r,overlap:i,norm:{x:0,y:-1},mtv:{x:0,y:-i},pos:t.geometry.getFarthestHullPoint(f,l).rotate(u).values()},h.push(c)),o.done(),h},i=function(e,t,n){return r(e,t,n)},s={aabb:null,restitution:.99,cof:1};return{init:function(n){t.init.call(this,n),this.options=e.util.extend({},this.options,s,n),this.setAABB(n.aabb),this.restitution=n.restitution,this._dummy=e.body("_dummy",function(){},{fixed:!0,restitution:this.options.restitution,cof:this.options.cof})},setAABB:function(e){if(!e)throw"Error: aabb not set";e=e.get&&e.get()||e,this._edges={min:{x:e.pos.x-e.x,y:e.pos.y-e.y},max:{x:e.pos.x+e.x,y:e.pos.y+e.y}}},connect:function(e){e.subscribe("integrate:velocities",this.checkAll,this)},disconnect:function(e){e.unsubscribe("integrate:velocities",this.checkAll)},checkAll:function(e){for(var t,r,s=e.bodies,o=(e.dt,[]),u=this._edges,a=this._dummy,f=0,l=s.length;l>f;f++)t=s[f],t.fixed||(r=i(t,u,a),r&&o.push.apply(o,r));o.length&&this._world.publish({topic:n,collisions:o})}}}),e.behavior("newtonian",function(t){var n={strength:1};return{init:function(r){t.init.call(this,r),r=e.util.extend({},n,r),this.strength=r.strength,this.tolerance=r.tolerance||100*this.strength},behave:function(t){for(var n,r,i,s,o=t.bodies,u=this.strength,f=this.tolerance,l=e.scratchpad(),c=l.vector(),h=0,p=o.length;p>h;h++){n=o[h];for(var d=h+1;p>d;d++)r=o[d],c.clone(r.state.pos),c.vsub(n.state.pos),i=c.normSq(),i>f&&(s=u/i,n.accelerate(c.normalize().mult(s*r.mass)),r.accelerate(c.mult(n.mass/r.mass).negate()))}l.done()}}}),e.behavior("rigid-constraint-manager",function(t){var n={targetLength:20};return{init:function(r){t.init.call(this,r),e.util.extend(this.options,n,r),this._constraints=[]},connect:function(e){var t=e.integrator();if(t&&t.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';e.subscribe("integrate:positions",this.resolve,this)},disconnect:function(e){e.unsubscribe("integrate:positions",this.resolve)},drop:function(){return this._constraints=[],this},constrain:function(t,n,r){var i;return t&&n?(this._constraints.push(i={id:e.util.uniqueId("rigid-constraint"),bodyA:t,bodyB:n,targetLength:r||this.options.targetLength}),i):!1},remove:function(t){var n,r=this._constraints;if("number"==typeof t)return r.splice(t,1),this;n=e.util.isObject(t);for(var i=0,s=r.length;s>i;++i)if(n&&r[i]===t||!n&&r[i].id===t)return r.splice(i,1),this;return this},resolve:function(){for(var t,n,r,i,s=this._constraints,o=e.scratchpad(),u=o.vector(),f=o.vector(),l=0,c=s.length;c>l;++l)t=s[l],u.clone(t.bodyA.state.pos),f.clone(t.bodyB.state.pos).vsub(u),n=f.norm(),r=(n-t.targetLength)/n,f.mult(r),i=t.bodyB.mass/(t.bodyA.mass+t.bodyB.mass),t.bodyA.fixed||(f.mult(i),t.bodyA.state.pos.vadd(f),f.mult(1/i)),t.bodyB.fixed||(f.mult(1-i),t.bodyB.state.pos.vsub(f));o.done()},getConstraints:function(){return[].concat(this._constraints)}}}),e.behavior("sweep-prune",function(t){function n(e,t){return e===t?!1:e>t?e<<16|65535&t:t<<16|65535&e}var r="collisions:candidates",i=1,s=function(){return i++},o={x:0,y:1};return{init:function(e){t.init.call(this,e),this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists={};for(var e in o)this.intervalLists[e]=[]},connect:function(e){e.subscribe("add:body",this.trackBody,this),e.subscribe("remove:body",this.untrackBody,this),e.subscribe("integrate:velocities",this.sweep,this);for(var t=e.getBodies(),n=0,r=t.length;r>n;++n)this.trackBody({body:t[n]})},disconnect:function(e){e.unsubscribe("add:body",this.trackBody),e.unsubscribe("remove:body",this.untrackBody),e.unsubscribe("integrate:velocities",this.sweep),this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this.checkOverlaps()},sortIntervalLists:function(){var e,t,n,r,i,s,u,a,f;for(var l in o)for(e=this.intervalLists[l],n=0,t=e.length,f=o[l];++n<t;){for(i=e[n],s=i.val.get(f),r=n,u=e[r-1],a=u&&u.val.get(f);r>0&&(a>s||a===s&&u.type&&!i.type);)e[r]=u,r--,u=e[r-1],a=u&&u.val.get(f);e[r]=i}},getPair:function(e,t,r){var i=n(e.id,t.id);if(i===!1)return null;var s=this.pairs[i];if(!s){if(!r)return null;s=this.pairs[i]={bodyA:e.body,bodyB:t.body,flag:0}}return s},checkOverlaps:function(){var e,t,n,r,i,s,u,a,f,l=o.z||o.y||o.x,c=[],h=0,p=[];for(var d in o)for(e="x"===d,i=this.intervalLists[d],u=-1,s=i.length;++u<s;)if(r=i[u],t=r.tracker,r.type)for(a=h;--a>=0;)n=c[a],n===t?(h-1>a?c[a]=c.pop():c.pop(),h--):(f=this.getPair(t,n,e),f&&(f.flag=e?0:f.flag+1,f.flag===l&&p.push(f)));else h=c.push(t);return p},updateIntervals:function(){for(var t,n,r=e.scratchpad(),i=r.vector(),s=r.vector(),o=this.tracked,u=o.length;--u>=0;)t=o[u],n=t.interval,i.clone(t.body.state.pos),s.clone(t.body.aabb()),n.min.val.clone(i).vsub(s),n.max.val.clone(i).vadd(s);r.done()},trackBody:function(t){var n=t.body,r={id:s(),body:n},i={min:{type:!1,val:e.vector(),tracker:r},max:{type:!0,val:e.vector(),tracker:r}};r.interval=i,this.tracked.push(r);for(var u in o)this.intervalLists[u].push(i.min,i.max)},untrackBody:function(e){for(var t,n,r,i,s=e.body,u=this.tracked,a=0,f=u.length;f>a;++a)if(r=u[a],r.body===s){u.splice(a,1);for(var l in o){i=0,t=this.intervalLists[l];for(var c=0,h=t.length;h>c;++c)if(n=t[c],n===r.interval.min||n===r.interval.max){if(t.splice(c,1),c--,f--,i>0)break;i++}}break}},sweep:function(e){var t,n=this;e.bodies,e.dt,t=n.broadPhase(),t.length&&this._world.publish({topic:r,candidates:t})}}}),e.behavior("verlet-constraints",function(t){var n=2*Math.PI,r={iterations:2};return{init:function(n){t.init.call(this,n),e.util.extend(this.options,r,n),this._distanceConstraints=[],this._angleConstraints=[]},connect:function(e){var t=e.integrator();if(t&&t.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';e.subscribe("integrate:positions",this.resolve,this)},disconnect:function(e){e.unsubscribe("integrate:positions",this.resolve)},drop:function(){return this._distanceConstraints=[],this._angleConstraints=[],this},distanceConstraint:function(t,n,r,i){var s;return t&&n?(s={id:e.util.uniqueId("dis-constraint"),type:"dis",bodyA:t,bodyB:n,stiffness:r||.5,targetLength:i||n.state.pos.dist(t.state.pos)},s.targetLengthSq=s.targetLength*s.targetLength,this._distanceConstraints.push(s),s):!1},angleConstraint:function(t,n,r,i,s){var o;return t&&n?(o={id:e.util.uniqueId("ang-constraint"),type:"ang",bodyA:t,bodyB:n,bodyC:r,stiffness:i||.5,targetAngle:s||n.state.pos.angle2(t.state.pos,r.state.pos)},this._angleConstraints.push(o),o):!1},remove:function(t){var n,r,i,s,o;if(i=e.util.isObject(t),r=i?t.type:t.substr(0,3),n="ang"===r?this._angleConstraints:this._distanceConstraints,i){for(s=0,o=n.length;o>s;++s)if(n[s]===t)return n.splice(s,1),this}else for(s=0,o=n.length;o>s;++s)if(n[s].id===t)return n.splice(s,1),this;return this},resolveAngleConstraints:function(t){for(var r,i,s,o,u=this._angleConstraints,f=e.scratchpad(),l=f.transform(),h=0,p=u.length;p>h;++h)r=u[h],i=r.bodyB.state.pos.angle2(r.bodyA.state.pos,r.bodyC.state.pos),s=i-r.targetAngle,s&&(s<=-Math.PI?s+=n:s>=Math.PI&&(s-=n),l.setTranslation(r.bodyB.state.pos),s*=-t*r.stiffness,r.bodyA.fixed||r.bodyB.fixed||r.bodyC.fixed||(o=1/(r.bodyA.mass+r.bodyB.mass+r.bodyC.mass)),r.bodyA.fixed||(i=r.bodyB.fixed||r.bodyC.fixed?r.bodyB.fixed?s*r.bodyC.mass/(r.bodyC.mass+r.bodyA.mass):s*r.bodyB.mass/(r.bodyB.mass+r.bodyA.mass):s*(r.bodyB.mass+r.bodyC.mass)*o,l.setRotation(i),r.bodyA.state.pos.translateInv(l),r.bodyA.state.pos.rotate(l),r.bodyA.state.pos.translate(l)),r.bodyC.fixed||(i=r.bodyA.fixed||r.bodyB.fixed?r.bodyB.fixed?-s*r.bodyA.mass/(r.bodyC.mass+r.bodyA.mass):-s*r.bodyB.mass/(r.bodyB.mass+r.bodyC.mass):-s*(r.bodyB.mass+r.bodyA.mass)*o,l.setRotation(i),r.bodyC.state.pos.translateInv(l),r.bodyC.state.pos.rotate(l),r.bodyC.state.pos.translate(l)),r.bodyB.fixed||(i=r.bodyA.fixed||r.bodyC.fixed?r.bodyA.fixed?s*r.bodyC.mass/(r.bodyC.mass+r.bodyB.mass):s*r.bodyA.mass/(r.bodyA.mass+r.bodyC.mass):s*(r.bodyA.mass+r.bodyC.mass)*o,l.setRotation(i).setTranslation(r.bodyA.state.pos),r.bodyB.state.pos.translateInv(l),r.bodyB.state.pos.rotate(l),r.bodyB.state.pos.translate(l),l.setTranslation(r.bodyC.state.pos),r.bodyB.state.pos.translateInv(l),r.bodyB.state.pos.rotateInv(l),r.bodyB.state.pos.translate(l)));f.done()},resolveDistanceConstraints:function(t){for(var n,r,i,s,o=this._distanceConstraints,u=e.scratchpad(),f=u.vector(),l=0,c=o.length;c>l;++l)n=o[l],f.clone(n.bodyB.state.pos).vsub(n.bodyA.state.pos),r=f.normSq()||1e-4*Math.random(),i=t*n.stiffness*(r-n.targetLengthSq)/r,f.mult(i),s=n.bodyA.fixed||n.bodyB.fixed?1:n.bodyB.mass/(n.bodyA.mass+n.bodyB.mass),n.bodyA.fixed||(n.bodyB.fixed||f.mult(s),n.bodyA.state.pos.vadd(f),n.bodyB.fixed||f.mult(1/s)),n.bodyB.fixed||(n.bodyA.fixed||f.mult(1-s),n.bodyB.state.pos.vsub(f));u.done()},shuffleConstraints:function(){this._distanceConstraints=e.util.shuffle(this._distanceConstraints),this._angleConstraints=e.util.shuffle(this._angleConstraints)},resolve:function(){for(var e=this.options.iterations,t=1/e,n=0;e>n;n++)this.resolveDistanceConstraints(t),this.resolveAngleConstraints(t)},getConstraints:function(){return{distanceConstraints:[].concat(this._distanceConstraints),angleConstraints:[].concat(this._angleConstraints)}}}}),e.integrator("improved-euler",function(t){return{init:function(e){t.init.call(this,e)},integrateVelocities:function(e,t){for(var n,r=1-this.options.drag,i=null,s=0,o=e.length;o>s;++s)i=e[s],n=i.state,i.fixed?(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0):(n.old.vel.clone(n.vel),n.old.acc.clone(n.acc),n.vel.vadd(n.acc.mult(t)),r&&n.vel.mult(r),n.acc.zero(),n.old.angular.vel=n.angular.vel,n.angular.vel+=n.angular.acc*t,n.angular.acc=0)},integratePositions:function(t,n){for(var r,i=.5*n*n,s=null,o=e.scratchpad(),u=o.vector(),f=0,l=t.length;l>f;++f)s=t[f],r=s.state,s.fixed||(r.old.pos.clone(r.pos),u.clone(r.old.vel),r.pos.vadd(u.mult(n)).vadd(r.old.acc.mult(i)),r.old.acc.zero(),r.old.angular.pos=r.angular.pos,r.angular.pos+=r.old.angular.vel*n+r.old.angular.acc*i,r.old.angular.acc=0);o.done()}}}),e.renderer("canvas",function(t){var n=2*Math.PI,r=function(e,t){var n=document.createElement(e||"div");return t&&(n.innerHTML=t),n},i={debug:!1,metaEl:null,styles:{point:"rgba(80, 50, 100, 0.7)",circle:{strokeStyle:"rgba(70, 50, 100, 0.7)",lineWidth:1,fillStyle:"rgba(44, 105, 44, 0.7)",angleIndicator:"rgba(69, 51, 78, 0.7)"},"convex-polygon":{strokeStyle:"rgba(80, 50, 100, 0.7)",lineWidth:1,fillStyle:"rgba(114, 105, 124, 0.7)",angleIndicator:"rgba(69, 51, 78, 0.7)"}},offset:{x:0,y:0}},s=function(t,n){return e.util.isPlainObject(n)?e.util.extend({},t,n,s):void 0!==n?n:t};return{init:function(n){if(t.init.call(this,n),this.options=e.util.extend({},i,this.options,s),this.options.offset=e.vector(this.options.offset),this.hiddenCanvas=document.createElement("canvas"),this.hiddenCanvas.width=this.hiddenCanvas.height=100,!this.hiddenCanvas.getContext)throw"Canvas not supported";this.hiddenCtx=this.hiddenCanvas.getContext("2d");var o=this.el;if("CANVAS"!==o.nodeName.toUpperCase()&&(o=document.createElement("canvas"),this.el.appendChild(o),"string"==typeof this.options.el&&this.el===document.body&&(o.id=this.options.el),this.el=o),o.width=this.options.width,o.height=this.options.height,this.ctx=o.getContext("2d"),this.els={},this.options.meta){var u=this.options.metaEl||r();u.className="pjs-meta",this.els.fps=r("span"),this.els.ipf=r("span"),u.appendChild(r("span","fps: ")),u.appendChild(this.els.fps),u.appendChild(r("br")),u.appendChild(r("span","ipf: ")),u.appendChild(this.els.ipf),o.parentNode.insertBefore(u,o)}},setStyle:function(t,n){n=n||this.ctx,e.util.isObject(t)?(n.strokeStyle=t.strokeStyle,n.fillStyle=t.fillStyle,n.lineWidth=t.lineWidth):(n.fillStyle=n.strokeStyle=t,n.lineWidth=1)},drawCircle:function(e,t,r,i,s){s=s||this.ctx,s.beginPath(),this.setStyle(i,s),s.arc(e,t,r,0,n,!1),s.closePath(),s.stroke(),s.fill()},drawPolygon:function(e,t,n){var r=e[0],i=void 0===r.x?r.get(0):r.x,s=void 0===r.y?r.get(1):r.y,o=e.length;n=n||this.ctx,n.beginPath(),this.setStyle(t,n),n.moveTo(i,s);for(var u=1;o>u;++u)r=e[u],i=void 0===r.x?r.get(0):r.x,s=void 0===r.y?r.get(1):r.y,n.lineTo(i,s);o>2&&n.closePath(),n.stroke(),n.fill()},drawLine:function(e,t,n,r){var i=void 0===e.x?e.get(0):e.x,s=void 0===e.y?e.get(1):e.y;r=r||this.ctx,r.beginPath(),this.setStyle(n,r),r.moveTo(i,s),i=void 0===t.x?t.get(0):t.x,s=void 0===t.y?t.get(1):t.y,r.lineTo(i,s),r.stroke(),r.fill()},createView:function(e,t){var n=new Image,r=e.aabb(),i=r.halfWidth+Math.abs(r.pos.x),s=r.halfHeight+Math.abs(r.pos.y),o=i+1,u=s+1,a=this.hiddenCtx,f=this.hiddenCanvas,l=e.name;return t=t||this.options.styles[l],o+=0|t.lineWidth,u+=0|t.lineWidth,f.width=2*i+2+(0|2*t.lineWidth),f.height=2*s+2+(0|2*t.lineWidth),a.save(),a.translate(o,u),"circle"===l?this.drawCircle(0,0,e.radius,t,a):"convex-polygon"===l&&this.drawPolygon(e.vertices,t,a),t.angleIndicator&&(a.beginPath(),this.setStyle(t.angleIndicator,a),a.moveTo(0,0),a.lineTo(i,0),a.closePath(),a.stroke()),a.restore(),n.src=f.toDataURL("image/png"),n.width=f.width,n.height=f.height,n},drawMeta:function(e){this.els.fps.innerHTML=e.fps.toFixed(2),this.els.ipf.innerHTML=e.ipf},beforeRender:function(){this.ctx.clearRect(0,0,this.el.width,this.el.height)},drawBody:function(e,t){var n=this.ctx,r=e.state.pos,i=this.options.offset,s=e.aabb();n.save(),n.translate(r.get(0)+i.get(0),r.get(1)+i.get(1)),n.rotate(e.state.angular.pos),n.drawImage(t,-t.width/2,-t.height/2),n.restore(),this.options.debug&&(n.save(),n.translate(i.get(0),i.get(1)),this.drawPolygon([{x:s.pos.x-s.x,y:s.pos.y-s.y},{x:s.pos.x+s.x,y:s.pos.y-s.y},{x:s.pos.x+s.x,y:s.pos.y+s.y},{x:s.pos.x-s.x,y:s.pos.y+s.y}],"rgba(100, 255, 100, 0.3)"),n.restore())}}}),e.renderer("dom",function(e){var t,n={},r=document.createElement("div"),i=function(e){return e.replace(/(?:^|\s)\w/g,function(e){return e.toUpperCase()})},s=function(e){if(n[e])return n[e];for(var t,s=["Webkit","Moz","Ms","O"],o=0,u=s.length;u>o;++o)if(t=s[o]+i(e),t in r.style)return n[e]=t;return t in r.style?n[e]=e:!1},o="pjs-",u="px",a=s("transform"),f=function(e,t){var n=document.createElement(e||"div");return t&&(n.innerHTML=t),n};return t=a?function(e,t){var n=e.state.pos;t.style[a]="translate("+n.get(0)+"px,"+n.get(1)+"px) rotate("+e.state.angular.pos+"rad)"}:function(e,t){var n=e.state.pos;t.style.left=n.get(0)+u,t.style.top=n.get(1)+u},{init:function(t){e.init.call(this,t);var n=this.el;if(n.style.position="relative",n.style.overflow="hidden",n.style[a]="translateZ(0)",n.style.width=this.options.width+u,n.style.height=this.options.height+u,this.els={},t.meta){var r=f();r.className="pjs-meta",this.els.fps=f("span"),this.els.ipf=f("span"),r.appendChild(f("span","fps: ")),r.appendChild(this.els.fps),r.appendChild(f("br")),r.appendChild(f("span","ipf: ")),r.appendChild(this.els.ipf),n.appendChild(r)}},circleProperties:function(e,t){var n=t.aabb();e.style.width=2*n.halfWidth+u,e.style.height=2*n.halfHeight+u,e.style.marginLeft=-n.halfWidth+u,e.style.marginTop=-n.halfHeight+u},createView:function(e){var t=f(),n=e.name+"Properties";return t.className=o+e.name,t.style.position="absolute",t.style.top="0px",t.style.left="0px",this[n]&&this[n](t,e),this.el.appendChild(t),t},drawMeta:function(e){this.els.fps.innerHTML=e.fps.toFixed(2),this.els.ipf.innerHTML=e.ipf},drawBody:t}}),e});